<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Botanica - Botanical Music Sequencer</title>
    <style>
        :root {
            --bg-color: #0a1f0a;
            --text-color: #e6f0e6;
            --accent-color: #4caf50;
            --secondary-color: #8bc34a;
            --tertiary-color: #cddc39;
            --soil-color: #3e2723;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.2);
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 300;
            letter-spacing: 2px;
        }

        .logo svg {
            height: 2rem;
            width: 2rem;
            fill: var(--accent-color);
        }

        .controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        button {
            background-color: var(--accent-color);
            color: var(--bg-color);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        button:hover {
            background-color: var(--secondary-color);
        }

        .play-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 220px;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            overflow-y: auto;
            z-index: 50;
        }

        .seed-palette {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .seed-category {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .seed-category h3 {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: var(--secondary-color);
            font-weight: normal;
        }

        .seeds {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .seed {
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
        }

        .seed:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        .seed.selected {
            background-color: var(--accent-color);
            color: var(--bg-color);
            box-shadow: 0 0 10px var(--accent-color);
        }

        .seed svg {
            width: 24px;
            height: 24px;
        }

        /* Seed colors */
        .drum-seed svg { color: #ff7043; }
        .bass-seed svg { color: #42a5f5; }
        .melody-seed svg { color: #9ccc65; }
        .pad-seed svg { color: #ba68c8; }

        .seed.selected.drum-seed svg,
        .seed.selected.bass-seed svg,
        .seed.selected.melody-seed svg,
        .seed.selected.pad-seed svg {
            color: var(--bg-color); /* Change icon color when selected */
        }


        .garden {
            flex: 1;
            position: relative;
            background: linear-gradient(to bottom, var(--bg-color), #071807);
            overflow: hidden;
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="%234caf50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M12 22v-8"></path><path d="M12 8V2"></path></svg>') 16 16, auto; /* Plant tool cursor */
        }
        .garden[data-tool="prune"] {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="%23f44336" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 19L19 17L12 10L10 12L17 19Z"></path><path d="M15 15L17 17"></path><path d="M8.5 8.5L6 6"></path><path d="M18 13L15 10"></path><path d="M14 11L11 8"></path><path d="M12 20C12 20 18 19 18 15V9L12 4L6 9V15C6 19 12 20 12 20Z"></path></svg>') 16 16, pointer;
        }
        .garden[data-tool="water"] {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="%2342a5f5" stroke="%2342a5f5" stroke-width="0" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z"></path><path d="M8 12h8"></path><path d="M12 8v8"></path></svg>') 16 16, pointer;
        }
        .garden[data-tool="select"] {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="%23ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12V3a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v9m-4 0v-4H8v4m0 0H4m16 0h-4M12 22a2 2 0 0 0 2-2v-4h-4v4a2 2 0 0 0 2 2Z"></path></svg>') 16 16, pointer;
        }


        #soil {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 20%;
            background-color: var(--soil-color);
            border-top: 2px solid rgba(255, 255, 255, 0.1);
        }

        .toolbar {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0.5rem;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 0.5rem;
            border-radius: 8px;
            z-index: 90;
        }

        .tool {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
            color: var(--text-color);
        }

        .tool:hover, .tool.active {
            background-color: var(--accent-color);
            color: var(--bg-color);
        }

        .tool svg {
            width: 20px;
            height: 20px;
        }

        .status-bar {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            display: flex;
            gap: 1rem;
            align-items: center;
            z-index: 90;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .status-item svg {
            width: 16px;
            height: 16px;
        }

        .weather-selector {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 0.5rem;
            border-radius: 8px;
            display: flex;
            gap: 0.5rem;
            z-index: 90;
        }

        .weather-option {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: rgba(255, 255, 255, 0.7);
            background-color: rgba(255, 255, 255, 0.1);
        }

        .weather-option:hover, .weather-option.active {
            background-color: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .weather-option svg {
            width: 20px;
            height: 20px;
        }

        .season-selector {
            position: absolute;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            padding: 0.5rem;
            border-radius: 8px;
            display: flex;
            gap: 0.5rem;
            z-index: 90;
        }

        .season-option {
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            color: rgba(255, 255, 255, 0.7);
            background-color: rgba(255, 255, 255, 0.1);
            font-size: 0.8rem;
        }

        .season-option:hover, .season-option.active {
            background-color: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background-color: #0f2f0f;
            border-radius: 8px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: normal;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 1.5rem;
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem;
        }

        .saved-gardens {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px; /* For scrollbar */
        }

        .saved-garden {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .saved-garden:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .garden-name {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .garden-date {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .create-garden {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .create-garden input {
            flex: 1;
            padding: 0.5rem;
            background-color: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 4px;
            color: var(--text-color);
            outline: none;
        }
        .create-garden input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .plant {
            position: absolute;
            transform-origin: center bottom;
            transition: transform 0.5s;
            pointer-events: auto; /* Allow clicks on plants */
            filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));
        }

        .plant:hover {
            filter: brightness(1.2);
        }

        .plant-stem {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            background-color: #2e7d32;
            transition: height 0.5s ease-out, background-color 0.5s;
        }

        .plant-head {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.5s ease-out;
        }
        .plant-head svg {
            width: 100%;
            height: 100%;
        }


        .bloom-particles {
            position: absolute;
            pointer-events: none;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            opacity: 0.8;
            pointer-events: none;
            z-index: 6; /* Above plants for visual effect */
        }

        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            transform: translateX(-50%);
            top: 4.5rem; /* Below status bar */
        }

        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 80%; /* Covers the plantable area */
            display: none;
            pointer-events: none;
            z-index: 1;
        }

        .grid-line {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.05);
        }

        .vertical-line {
            width: 1px;
            height: 100%;
        }

        .horizontal-line {
            width: 100%;
            height: 1px;
        }

        .playhead {
            position: absolute;
            top: 0;
            width: 2px;
            height: 80%; /* Only above soil */
            background-color: rgba(255, 255, 255, 0.5);
            pointer-events: none;
            display: none;
            z-index: 5;
            transform: translateX(0%);
            transition: transform 0.05s linear; /* Smooth movement */
        }

        .time-markers {
            position: absolute;
            bottom: 20%;
            left: 0;
            width: 100%;
            height: 20px;
            display: flex;
            pointer-events: none;
            z-index: 2;
        }

        .time-marker {
            position: absolute;
            bottom: 0;
            width: 1px;
            height: 10px;
            background-color: rgba(255, 255, 255, 0.3);
        }

        .time-marker-label {
            position: absolute;
            bottom: 12px;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .water-system {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 80%;
            pointer-events: none;
        }

        .water-droplet {
            position: absolute;
            width: 10px;
            height: 15px;
            background-color: rgba(66, 165, 245, 0.6);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            pointer-events: none;
            opacity: 0;
            filter: blur(1px);
        }

        .settings-panel {
            position: absolute;
            right: 1rem;
            top: 4rem;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 1rem;
            display: none;
            flex-direction: column;
            gap: 1rem;
            z-index: 95;
        }

        .settings-panel.active {
            display: flex;
        }

        .settings-group {
            margin-bottom: 0.5rem;
        }

        .settings-group h3 {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: var(--secondary-color);
            font-weight: normal;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .slider-label {
            width: 80px;
            font-size: 0.8rem;
        }

        .slider {
            flex: 1;
            -webkit-appearance: none;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
        }

        .slider-value {
            width: 40px;
            font-size: 0.8rem;
            text-align: right;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .toggle-label {
            flex: 1;
            font-size: 0.8rem;
        }

        .toggle {
            position: relative;
            width: 40px;
            height: 20px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--accent-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .clouds {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 40%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 1s;
        }

        .cloud {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            filter: blur(15px);
        }

        .rain {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 80%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 1s;
        }

        .raindrop {
            position: absolute;
            width: 2px;
            height: 20px;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(116, 185, 255, 0.5));
            border-radius: 0 0 5px 5px;
        }

        .sun {
            position: absolute;
            top: 50px;
            right: 50px;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, rgba(255, 236, 95, 1) 0%, rgba(255, 167, 37, 0.7) 70%, rgba(255, 137, 0, 0) 100%);
            border-radius: 50%;
            filter: blur(5px);
            opacity: 0;
            transition: opacity 1s;
            pointer-events: none;
        }

        .sunbeam {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 1px;
            height: 80px; /* Length of the beam */
            background: linear-gradient(to bottom, rgba(255, 236, 95, 0.5), rgba(255, 236, 95, 0));
            transform-origin: top center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 1s;
        }

        .butterflies {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden; /* Keep butterflies within garden */
        }

        .butterfly {
            position: absolute;
            width: 20px;
            height: 20px;
            pointer-events: none;
            transition: transform 0.1s ease-in-out;
        }

        .butterfly svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.5));
        }

        .tutorial {
            position: absolute;
            bottom: 5rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            max-width: 400px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 100;
        }

        .tutorial.active {
            opacity: 1;
        }

        .tutorial-button {
            margin-top: 0.5rem;
            padding: 0.25rem 1rem;
            background-color: var(--accent-color);
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
        }

        @keyframes float {
            0% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes wiggle {
            0% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
            100% { transform: rotate(-3deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes moveClouds {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(200%); }
        }

        @keyframes rainFall {
            0% { transform: translateY(-20px) rotate(15deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(15deg); opacity: 0; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2"/>
                <path d="M12 7V12L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <h1>BOTANICA</h1>
        </div>
        <div class="controls">
            <button id="save-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                Save Garden
            </button>
            <button id="load-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 1 2-2v-4M17 9l-5 5-5-5M12 12.8V3"></path>
                </svg>
                Load Garden
            </button>
            <button class="play-button" id="play-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
                <span id="play-pause-text">Play</span>
            </button>
        </div>
    </header>

    <main>
        <div class="sidebar">
            <div class="seed-palette">
                <div class="seed-category">
                    <h3>RHYTHM</h3>
                    <div class="seeds">
                        <div class="seed drum-seed" data-type="kick" title="Kick Drum">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M8 12h8"></path>
                            </svg>
                        </div>
                        <div class="seed drum-seed" data-type="snare" title="Snare Drum">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M8 12h8"></path>
                                <path d="M12 8v8"></path>
                            </svg>
                        </div>
                        <div class="seed drum-seed" data-type="hihat" title="Hi-hat">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M15 2H9"></path>
                                <path d="M12 14h.01"></path>
                                <path d="M12 22v-8"></path>
                                <path d="M7 8a5 5 0 0 1 10 0"></path>
                            </svg>
                        </div>
                        <div class="seed drum-seed" data-type="percussion" title="Percussion">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M6 9l6 6 6-6"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="seed-category">
                    <h3>BASS</h3>
                    <div class="seeds">
                        <div class="seed bass-seed" data-type="bass-simple" title="Simple Bass">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M9 18V5l12-2v13"></path>
                                <circle cx="6" cy="18" r="3"></circle>
                                <circle cx="18" cy="16" r="3"></circle>
                            </svg>
                        </div>
                        <div class="seed bass-seed" data-type="bass-groove" title="Groove Bass">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M9 17V5l12-2v10"></path>
                                <circle cx="6" cy="17" r="3"></circle>
                                <path d="M16 17h3a2 2 0 1 0 0-4h-3v-1a1 1 0 0 1 1-1h2"></path>
                            </svg>
                        </div>
                        <div class="seed bass-seed" data-type="bass-wobble" title="Wobble Bass">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M2 18C2 14 12 2 22 18"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="seed-category">
                    <h3>MELODY</h3>
                    <div class="seeds">
                        <div class="seed melody-seed" data-type="melody-bell" title="Bell Melody">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M18 8a6 6 0 0 0-9.33-5"></path>
                                <path d="M6 8a6 6 0 0 1 9.33-5"></path>
                                <path d="M6 15h12"></path>
                                <path d="M9 19h6"></path>
                                <path d="M10 19v-4"></path>
                                <path d="M14 19v-4"></path>
                            </svg>
                        </div>
                        <div class="seed melody-seed" data-type="melody-keys" title="Keys Melody">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect><path d="M16 2L8 2"></path><path d="M15 7V2"></path><path d="M9 7V2"></path>
                            </svg>
                        </div>
                        <div class="seed melody-seed" data-type="melody-arpeggio" title="Arpeggio Melody">
                             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 16L14 8L10 24"></path></svg>
                        </div>
                    </div>
                </div>

                <div class="seed-category">
                    <h3>PADS</h3>
                    <div class="seeds">
                        <div class="seed pad-seed" data-type="pad-ambient" title="Ambient Pad">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 19L19 17L12 10L10 12L17 19Z"></path><path d="M15 15L17 17"></path><path d="M8.5 8.5L6 6"></path><path d="M18 13L15 10"></path><path d="M14 11L11 8"></path><path d="M12 20C12 20 18 19 18 15V9L12 4L6 9V15C6 19 12 20 12 20Z"></path></svg>
                        </div>
                        <div class="seed pad-seed" data-type="pad-warm" title="Warm Pad">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect><path d="M16 2L8 2"></path><path d="M15 7V2"></path><path d="M9 7V2"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="garden" id="garden-container">
            <div id="soil"></div>

            <!-- Global visual effects containers -->
            <div class="clouds" id="clouds"></div>
            <div class="rain" id="rain"></div>
            <div class="sun" id="sun"></div>
            <div class="sunbeam" id="sunbeam"></div>
            <div class="butterflies" id="butterflies"></div>

            <!-- Musical Grid and Playhead -->
            <div class="grid-overlay" id="grid-overlay"></div>
            <div class="playhead" id="playhead"></div>
            <div class="time-markers" id="time-markers"></div>

            <!-- Garden Controls and Status -->
            <div class="weather-selector" id="weather-selector">
                <div class="weather-option active" data-weather="sunny" title="Sunny (Bright tones, faster growth)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                </div>
                <div class="weather-option" data-weather="cloudy" title="Cloudy (Muted tones, ambient)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 1 1 11.21 3 7 7 0 0 0 21 12.79"></path></svg>
                </div>
                <div class="weather-option" data-weather="rainy" title="Rainy (Percussive, watery effects)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="18" x2="12" y2="18.01"></line><line x1="16" y1="16" x2="16" y2="16.01"></line><line x1="8" y1="16" x2="8" y2="16.01"></line><path d="M12 10a7 7 0 0 0-7 7h14a7 7 0 0 0-7-7z"></path></svg>
                </div>
            </div>

            <div class="season-selector" id="season-selector">
                <div class="season-option active" data-season="spring" title="Spring (Lively, major)">Spring</div>
                <div class="season-option" data-season="summer" title="Summer (Lush, sustained)">Summer</div>
                <div class="season-option" data-season="autumn" title="Autumn (Minor, decaying)">Autumn</div>
                <div class="season-option" data-season="winter" title="Winter (Sparse, icy)">Winter</div>
            </div>

            <div class="status-bar">
                <div class="status-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 21.5c-4.418 0-8-3.134-8-7s3.582-7 8-7 8 3.134 8 7-3.582 7-8 7z"></path><path d="M12 14c-1.105 0-2-.895-2-2s.895-2 2-2 2 .895 2 2-.895 2-2 2z"></path><path d="M12 21.5v-7.5m0-4v-7.5"></path></svg>
                    BPM: <span id="bpm-display">120</span>
                </div>
                <div class="status-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    Scale: <span id="scale-display">C Major</span>
                </div>
                <div class="status-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 6V12L16 14"></path></svg>
                    Growth: <span id="growth-rate-display">1x</span>
                </div>
            </div>

            <div class="toolbar">
                <div class="tool active" id="plant-tool" data-tool="plant" title="Plant Tool (Click to plant a seed)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M12 22v-8"></path><path d="M12 8V2"></path></svg>
                </div>
                <div class="tool" id="prune-tool" data-tool="prune" title="Prune Tool (Click a plant to remove)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 19L19 17L12 10L10 12L17 19Z"></path><path d="M15 15L17 17"></path><path d="M8.5 8.5L6 6"></path><path d="M18 13L15 10"></path><path d="M14 11L11 8"></path><path d="M12 20C12 20 18 19 18 15V9L12 4L6 9V15C6 19 12 20 12 20Z"></path></svg>
                </div>
                <div class="tool" id="water-tool" data-tool="water" title="Water Tool (Click a plant to water and boost growth)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z"></path><path d="M8 12h8"></path><path d="M12 8v8"></path></svg>
                </div>
                <div class="tool" id="select-tool" data-tool="select" title="Select Tool (Click a plant to adjust its parameters)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12V3a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v9m-4 0v-4H8v4m0 0H4m16 0h-4M12 22a2 2 0 0 0 2-2v-4h-4v4a2 2 0 0 0 2 2Z"></path></svg>
                </div>
                <div class="tool" id="grid-toggle" title="Toggle Grid Overlay">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="3" y1="15" x2="21" y2="15"></line><line x1="9" y1="3" x2="9" y2="21"></line><line x1="15" y1="3" x2="15" y2="21"></line></svg>
                </div>
                <div class="tool" id="settings-button" title="Open Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 6.1 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 6.1a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a2 2 0 0 1 2-2v-.09A1.65 1.65 0 0 0 12.9 4.6a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a2 2 0 0 1 2 2h.09a1.65 1.65 0 0 0 1.51 1.82 1.65 1.65 0 0 0 1.82.33l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33-1.82z"></path></svg>
                </div>
            </div>

            <div class="tooltip" id="tooltip"></div>
            <div class="bloom-particles" id="bloom-particles"></div>
            <div class="water-system" id="water-system"></div>
        </div>
    </main>

    <div class="modal" id="save-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Save Garden</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="create-garden">
                <input type="text" id="save-garden-name" placeholder="Enter garden name">
                <button id="confirm-save-button">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="load-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Load Garden</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="saved-gardens" id="saved-gardens-list">
                <!-- Saved gardens will be loaded here -->
            </div>
            <button id="clear-all-gardens" style="background-color: #f44336; margin-top: 1rem;">Clear All Saved Gardens</button>
        </div>
    </div>

    <div class="modal tutorial" id="tutorial-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Welcome to Botanica!</h2>
                <button class="close-modal">&times;</button>
            </div>
            <p>This is a botanical music sequencer. Plant seeds, watch them grow into music, and explore the ecosystem.</p>
            <ul>
                <li><strong>Plant Tool:</strong> Select a seed from the left palette, then click in the garden to plant it.</li>
                <li><strong>Prune Tool:</strong> Remove unwanted plants.</li>
                <li><strong>Water Tool:</strong> Speed up plant growth and intensity.</li>
                <li><strong>Select Tool:</strong> (Advanced) Not fully implemented yet, but for future detailed plant editing.</li>
                <li><strong>Weather & Seasons:</strong> Change the environment to influence the music.</li>
                <li><strong>Play/Pause:</strong> Start and stop the music.</li>
                <li><strong>Save/Load:</strong> Save your garden compositions.</li>
            </ul>
            <p>The horizontal axis represents time, the vertical axis represents musical pitch/register. As plants grow, they evolve musically.</p>
            <button class="tutorial-button" id="start-gardening-button">Start Gardening!</button>
        </div>
    </div>

    <!-- IMPORTANT: Tone.js and Tonal.js MUST be loaded BEFORE your custom script block. -->
    <!-- This ensures their global objects (Tone, Tonal) are available when your script runs. -->
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tonaljs/tonal@4.6.5/dist/bundle.min.js"></script>
    
    <script>
        console.log("Custom script tag loaded.");

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded event triggered. Starting Botanica application setup.");

            // --- Debugging Tonal.js availability ---
            console.log("Checking Tonal object availability before state definition:", typeof Tonal, Tonal);
            if (typeof Tonal === 'undefined' || Tonal === null) {
                console.error("ERROR: Tonal.js is still not defined! This indicates a loading issue. Please check network tab and script order.");
                alert("Critical Error: Music scale library (Tonal.js) failed to load. Check console for details.");
                return; // Stop execution if Tonal is not available
            }

            // --- Global State Variables ---
            const state = {
                isStarted: false,
                isPlaying: false,
                activeTool: 'plant', // 'plant', 'prune', 'water', 'select'
                selectedSeedType: null, // e.g., 'kick', 'bass-simple', 'melody-bell'
                plants: [], // Array of plant objects
                bpm: 120,
                masterVolume: -6,
                growthRate: 1, // Multiplier for growth
                currentWeather: 'sunny', // 'sunny', 'cloudy', 'rainy'
                currentSeason: 'spring', // 'spring', 'summer', 'autumn', 'winter'
                currentScale: 'C Major',
                scales: Tonal.Scale.names(), // This is where Tonal is first accessed!
                keys: Tonal.Note.names(),
                showGrid: true,
                tutorialShown: false,
                nextPlantId: 0,
                isAudioInitialized: false, // Track audio context state
            };
            console.log("State object defined. Tonal.Scale.names() called successfully.");
            console.log("Available Scales:", state.scales.slice(0, 5), "...");

            const plantDefinitions = {
                'kick': { type: 'drum', color: '#ff7043', sampleKey: 'kick', seqLength: 4, growDuration: 8, release: '8n', pattern: [1, 0, 0, 0], notes: ['C2'],
                    svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 12h8"></path></svg>` },
                'snare': { type: 'drum', color: '#ff7043', sampleKey: 'snare', seqLength: 4, growDuration: 8, release: '8n', pattern: [0, 0, 1, 0], notes: ['C2'],
                    svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 12h8"></path><path d="M12 8v8"></path></svg>` },
                'hihat': { type: 'drum', color: '#ff7043', sampleKey: 'hihat', seqLength: 8, growDuration: 16, release: '16n', pattern: [1, 1, 1, 1, 1, 1, 1, 1], notes: ['C2'],
                    svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H9"></path><path d="M12 14h.01"></path><path d="M12 22v-8"></path><path d="M7 8a5 5 0 0 1 10 0"></path></svg>` },
                'percussion': { type: 'drum', color: '#ff7043', sampleKey: 'percussion', seqLength: 8, growDuration: 16, release: '8n', pattern: [0, 1, 0, 1, 0, 1, 0, 1], notes: ['C2'],
                    svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"></path></svg>` },

                'bass-simple': { type: 'bass', color: '#42a5f5', seqLength: 16, growDuration: 32, pattern: [1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0], notes: ['C2'], instrumentType: 'synth',
                    synthSettings: { oscillator: { type: 'sine' }, envelope: { attack: 0.1, decay: 0.7, sustain: 0.4, release: 1.2 }},
                    svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>` },
                'bass-groove': { type: 'bass', color: '#42a5f5', seqLength: 16, growDuration: 32, pattern: [1, 0, 1, 0, 0, 1, 0, 0, 1, 0, 1, 0, 0, 1, 0, 0], notes: ['C2'], instrumentType: 'synth',
                    synthSettings: { oscillator: { type: 'sawtooth' }, envelope: { attack: 0.05, decay: 0.5, sustain: 0.3, release: 0.8 }},
                    svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 17V5l12-2v10"></path><circle cx="6" cy="17" r="3"></circle><path d="M16 17h3a2 2 0 1 0 0-4h-3v-1a1 1 0 0 1 1-1h2"></path></svg>` },
                'bass-wobble': { type: 'bass', color: '#42a5f5', seqLength: 8, growDuration: 16, pattern: [1, 0, 0, 1, 0, 0, 1, 0], notes: ['C2'], instrumentType: 'synth',
                    synthSettings: { oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.5 }, filter: { type: 'lowpass', rolloff: -24, Q: 6 }, filterEnvelope: { attack: 0.02, decay: 0.1, sustain: 0.1, release: 0.5, baseFrequency: 100, octaves: 4 }},
                    svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 18C2 14 12 2 22 18"></path></svg>` },

                'melody-bell': { type: 'melody', color: '#9ccc65', seqLength: 16, growDuration: 64, pattern: [1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0], notes: ['C4'], instrumentType: 'pluck',
                    synthSettings: { attackNoise: 1, resonance: 0.9, dampening: 4000, envelope: { attack: 0.005, decay: 0.5, sustain: 0, release: 1 } },
                    svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8a6 6 0 0 0-9.33-5"></path><path d="M6 8a6 6 0 0 1 9.33-5"></path><path d="M6 15h12"></path><path d="M9 19h6"></path><path d="M10 19v-4"></path><path d="M14 19v-4"></path></svg>` },
                'melody-keys': { type: 'melody', color: '#9ccc65', seqLength: 32, growDuration: 64, pattern: [1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0], notes: ['C4'], instrumentType: 'poly',
                    synthSettings: { oscillator: { type: 'triangle' }, envelope: { attack: 0.1, decay: 0.5, sustain: 0.3, release: 1 }},
                    svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect><path d="M16 2L8 2"></path><path d="M15 7V2"></path><path d="M9 7V2"></path></svg>` },
                'melody-arpeggio': { type: 'melody', color: '#9ccc65', seqLength: 16, growDuration: 64, pattern: [1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0], notes: ['C4'], instrumentType: 'mono',
                    synthSettings: { oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.5 }},
                    svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 16L14 8L10 24"></path></svg>` },

                'pad-ambient': { type: 'pad', color: '#ba68c8', seqLength: 1, growDuration: 128, pattern: [1], notes: ['C3'], instrumentType: 'poly',
                    synthSettings: { oscillator: { type: 'sawtooth' }, envelope: { attack: 2, decay: 1, sustain: 0.7, release: 3 }, volume: -10 },
                    svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 19L19 17L12 10L10 12L17 19Z"></path><path d="M15 15L17 17"></path><path d="M8.5 8.5L6 6"></path><path d="M18 13L15 10"></path><path d="M14 11L11 8"></path><path d="M12 20C12 20 18 19 18 15V9L12 4L6 9V15C6 19 12 20 12 20Z"></path></svg>` },
                'pad-warm': { type: 'pad', color: '#ba68c8', seqLength: 1, growDuration: 128, pattern: [1], notes: ['C3'], instrumentType: 'poly',
                    synthSettings: { oscillator: { type: 'triangle' }, envelope: { attack: 1.5, decay: 0.8, sustain: 0.6, release: 2.5 }, volume: -12 },
                    svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect><path d="M16 2L8 2"></path><path d="M15 7V2"></path><path d="M9 7V2"></path></svg>` },
            };

            // Initialize non-audio parts of the application first
            initializeNonAudioComponents();

            // Add a first-interaction handler to initialize audio
            const firstInteractionHandler = async () => {
                try {
                    if (!state.isAudioInitialized) {
                        await Tone.start();
                        console.log('Tone.js AudioContext started successfully after user interaction.');
                        state.isAudioInitialized = true;
                        // Now initialize audio-dependent components
                        await initializeAudioComponents(); 
                    }
                } catch (error) {
                    console.error("Error starting Tone.js AudioContext:", error);
                    // Optionally, display an error to the user
                }
                // Remove the event listeners after first interaction
                document.removeEventListener('click', firstInteractionHandler);
                document.removeEventListener('touchstart', firstInteractionHandler);
                // If tutorial was meant to show, and init was waiting, show it now
                if (!state.tutorialShown && tutorialModal) {
                     setTimeout(() => openModal(tutorialModal), 100); // Slight delay after audio init
                }
            };

            // Add event listeners for first interaction
            document.addEventListener('click', firstInteractionHandler);
            document.addEventListener('touchstart', firstInteractionHandler);

            // --- Core Functions ---

            async function initializeNonAudioComponents() {
                console.log("initializeNonAudioComponents() called.");
                // Parts of original init that don't require Tone.js to be started
                const defaultSeed = document.querySelector('.seed');
                if (defaultSeed) {
                    selectSeed(defaultSeed);
                }
                selectTool(document.getElementById('plant-tool'), 'plant');

                renderTimeMarkers();
                renderGrid();
                loadGardenState('__autosave__'); // Loads plant data, not audio objects

                // Tutorial modal can be prepared but shown after audio init if it depends on it
                // Or, if it's pure UI, it can be shown here. Let's assume it can be shown later.

                updateUI(); // General UI updates
                applyWeatherEffects(); // Visual effects
                applySeasonEffects(); // Visual effects

                setInterval(createButterfly, 5000); // Visual ambiance
                requestAnimationFrame(updatePlayhead); // UI updates for playhead
                console.log("Non-audio components initialized.");
            }

            async function initializeAudioComponents() {
                console.log("initializeAudioComponents() called.");
                if (!state.isAudioInitialized) {
                    console.warn("Audio components initialization called before Tone.start(). This shouldn't happen.");
                    // Attempt to start audio context here as a fallback, though ideally it's already started.
                    try {
                        await Tone.start();
                        state.isAudioInitialized = true;
                        console.log('Tone.js AudioContext started from initializeAudioComponents fallback.');
                    } catch (e) {
                        console.error('Failed to start audio context in initializeAudioComponents fallback:', e);
                        return; // Can't proceed with audio setup
                    }
                }
                
                setupAudioNodes();
                Tone.Transport.bpm.value = state.bpm;
                Tone.Transport.loop = true;
                Tone.Transport.loopEnd = '4m'; // Example, ensure this is appropriate

                // Re-initialize plants' audio if they were loaded before audio context was ready
                state.plants.forEach(plant => {
                    if (plant.instrument) plant.instrument.dispose(); // Dispose old if any
                    plant.setupInstrument();
                    plant.setupSequence();
                });
                console.log("Audio components initialized.");
            }

            async function init() { // This function is now primarily a placeholder or can be removed
                console.warn("Legacy init() function called. Ensure this is intended. Setup is now split into initializeNonAudioComponents and initializeAudioComponents triggered by DOMContentLoaded and user interaction respectively.");
                // Modern setup handles this. If this is still called, it might re-run things.
                // For safety, it could re-trigger the new flow if needed, but ideally, it's not called directly anymore.
            }

            async function togglePlay() {
                if (!state.isAudioInitialized) {
                    console.log("Play button clicked before audio context is initialized. Attempting to start audio...");
                    try {
                        await Tone.start();
                        state.isAudioInitialized = true;
                        console.log('Tone.js AudioContext started successfully via play button.');
                        await initializeAudioComponents(); // Initialize audio components now
                    } catch (error) {
                        console.error("Error starting Tone.js AudioContext via play button:", error);
                        // Optionally, display an error to the user
                        showTooltip("Could not start audio. Please click the page once and try again.");
                        return; // Don't proceed with playback if audio didn't start
                    }
                }

                if (!state.isStarted) {
                    Tone.start().then(() => {
                        state.isStarted = true;
                        startStopPlayback();
                    }).catch(e => {
                        console.error("Failed to start AudioContext:", e);
                        alert("Could not start audio. Please click the play button again or check browser console (F12).");
                    });
                } else {
                    startStopPlayback();
                }
            }

            function startStopPlayback() {
                if (state.isPlaying) {
                    Tone.Transport.pause();
                    playButtonSVG.innerHTML = `<polygon points="5 3 19 12 5 21 5 3"></polygon>`;
                    playPauseText.textContent = 'Play';
                    playhead.style.display = 'none';
                } else {
                    Tone.Transport.start();
                    playButtonSVG.innerHTML = `<rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect>`;
                    playPauseText.textContent = 'Pause';
                    playhead.style.display = 'block';
                }
                state.isPlaying = !state.isPlaying;
                updateUI();
            }

            let lastBeat = -1;
            function updatePlayhead() {
                if (!state.isPlaying) {
                    requestAnimationFrame(updatePlayhead);
                    return;
                }

                const transportTime = Tone.Transport.seconds;
                const totalLoopTime = Tone.Time(Tone.Transport.loopEnd).toSeconds();
                let progress = (transportTime % totalLoopTime) / totalLoopTime;

                const gardenWidth = gardenContainer.offsetWidth;
                const playheadPosition = progress * gardenWidth;

                playhead.style.transform = `translateX(${playheadPosition}px)`;

                const currentBeat = Math.floor(Tone.Transport.progress * 16);
                if (currentBeat !== lastBeat) {
                    lastBeat = currentBeat;
                }

                requestAnimationFrame(updatePlayhead);
            }

            // --- Plant Class ---
            class Plant {
                constructor(id, type, x, y, options = {}) {
                    this.id = id;
                    this.type = type;
                    this.x = x;
                    this.y = y;
                    this.growth = 0;
                    this.bloom = 0;
                    this.def = plantDefinitions[type];
                    this.color = this.def.color;
                    this.seqLength = this.def.seqLength;
                    this.growDuration = this.def.growDuration;
                    this.pattern = this.def.pattern;
                    this.notes = this.def.notes;
                    this.instrument = null;
                    this.sequence = null;
                    this.domElement = null;

                    console.log(`Creating new plant: ${this.type} at (${this.x.toFixed(2)}%, ${this.y.toFixed(2)}%)`);

                    if (options.growth !== undefined) {
                        this.growth = options.growth;
                    }

                    this.createDOMElement();
                    this.setupInstrument();
                    this.setupSequence();
                    this.updateVisuals();
                }

                createDOMElement() {
                    this.domElement = document.createElement('div');
                    this.domElement.classList.add('plant');
                    this.domElement.dataset.plantId = this.id;
                    this.domElement.dataset.type = this.type;
                    this.domElement.style.left = `${this.x}%`;
                    this.domElement.style.top = `${this.y}%`;
                    this.domElement.style.zIndex = Math.floor(this.y);

                    const stem = document.createElement('div');
                    stem.classList.add('plant-stem');
                    stem.style.backgroundColor = this.color;
                    this.domElement.appendChild(stem);
                    this.stemElement = stem;

                    const head = document.createElement('div');
                    head.classList.add('plant-head');
                    head.style.backgroundColor = this.color;
                    head.style.transform = `translateX(-50%)`;
                    head.style.borderRadius = '50%';
                    head.style.boxShadow = `0 0 10px ${this.color}`;

                    head.innerHTML = this.def.svg;
                    head.querySelector('svg').style.fill = 'currentColor';
                    head.querySelector('svg').style.color = 'white';
                    this.domElement.appendChild(head);
                    this.headElement = head;

                    gardenContainer.appendChild(this.domElement);
                    requestAnimationFrame(() => this.updateVisuals());
                }

                setupInstrument() {
                    let inst;
                    if (this.def.type === 'drum') {
                        inst = drums;
                    } else {
                        switch (this.def.instrumentType) {
                            case 'poly':
                                inst = new Tone.PolySynth(Tone.Synth, this.def.synthSettings);
                                break;
                            case 'pluck':
                                inst = new Tone.PluckSynth(this.def.synthSettings);
                                break;
                            case 'mono':
                                inst = new Tone.MonoSynth(this.def.synthSettings);
                                break;
                            default:
                                inst = new Tone.Synth(this.def.synthSettings);
                        }
                        inst.chain(masterFilter, masterReverb, masterDelay, masterCompressor, Tone.Destination);
                    }
                    this.instrument = inst;
                    if (this.instrument.volume) {
                        this.instrument.volume.value = -20 + (this.growth * 15);
                    }
                }

                setupSequence() {
                    const def = this.def;
                    const yAdjusted = this.y / 80;
                    const baseMIDI = 80;
                    const octaveRange = 48;
                    const midiBaseNote = baseMIDI - (yAdjusted * octaveRange);

                    let currentScaleNotes = [];
                    try {
                        const rootNoteName = Tonal.Note.fromMidi(midiBaseNote);
                        const rootPitchClass = Tonal.Note.pitchClass(rootNoteName);
                        const scaleType = Tonal.Scale.get(state.currentScale).type;

                        const scale = Tonal.Scale.get(`${rootPitchClass} ${scaleType}`);

                        if (!scale || !scale.notes || scale.notes.length === 0) {
                            throw new Error(`Scale definition problem for ${state.currentScale} with root ${rootPitchClass}.`);
                        }

                        const lowOctave = Math.floor(Tonal.Note.midi(rootNoteName) / 12) - 1;
                        const highOctave = lowOctave + 3;

                        for (let o = lowOctave; o <= highOctave; o++) {
                            scale.notes.forEach(noteInScale => {
                                currentScaleNotes.push(Tonal.Note.transpose(noteInScale, `${o}`));
                            });
                        }
                        currentScaleNotes.sort((a, b) => Tonal.Note.midi(a) - Tonal.Note.midi(b));
                        currentScaleNotes = currentScaleNotes.filter(note => {
                            const midi = Tonal.Note.midi(note);
                            return midi >= 36 && midi <= 96;
                        });

                        if (currentScaleNotes.length === 0) {
                            console.warn(`Plant ${this.id}: No valid notes generated for scale "${state.currentScale}" near MIDI ${midiBaseNote}. Falling back to default C Major notes.`);
                            currentScaleNotes = ['C3', 'D3', 'E3', 'F3', 'G3', 'A3', 'B3', 'C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'];
                        }

                    } catch (e) {
                        console.error(`Plant ${this.id}: Error generating notes for scale "${state.currentScale}". Falling back to default C Major notes.`, e);
                        if (typeof Tonal !== 'undefined' && Tonal.Scale && Tonal.Note) {
                             currentScaleNotes = Tonal.Scale.get('C Major').notes.map(n => {
                                return Tonal.Note.transpose(n, '3');
                            }).concat(Tonal.Scale.get('C Major').notes.map(n => {
                                return Tonal.Note.transpose(n, '4');
                            }));
                        } else {
                            currentScaleNotes = ['C3', 'D3', 'E3', 'F3', 'G3', 'A3', 'B3', 'C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'];
                        }
                    }

                    if (def.type === 'bass') {
                        currentScaleNotes = currentScaleNotes.map(note => {
                            const midi = Tonal.Note.midi(note);
                            return Tonal.Note.fromMidi(midi - 24);
                        }).filter(note => Tonal.Note.midi(note) >= 24 && Tonal.Note.midi(note) <= 60);
                    }

                    const events = def.pattern.map((active, i) => {
                        if (!active) return null;

                        let note = null;
                        if (def.type === 'drum') {
                            note = def.sampleKey;
                        } else {
                            const growthFactor = Math.floor(this.growth * (currentScaleNotes.length - 1));
                            const noteIndex = (i + growthFactor) % currentScaleNotes.length;
                            note = currentScaleNotes[noteIndex];

                            if (this.growth > 0.5 && Math.random() < 0.3 * this.growth) {
                                const jumpAmount = Math.random() < 0.5 ? 12 : -12;
                                const originalMidi = Tonal.Note.midi(note);
                                if (originalMidi !== null) {
                                    const jumpedNoteMidi = originalMidi + jumpAmount;
                                    if (jumpedNoteMidi >= 36 && jumpedNoteMidi <= 96) {
                                        note = Tonal.Note.fromMidi(jumpedNoteMidi);
                                    }
                                }
                            }
                        }
                        return { time: `0:${i}`, note: note };
                    }).filter(Boolean);

                    const dynamicSeqLength = Math.max(1, Math.floor(this.seqLength * (0.5 + this.growth * 0.5)));
                    const loopEnd = `0:${dynamicSeqLength}`;

                    if (this.sequence) {
                        this.sequence.dispose();
                    }

                    this.sequence = new Tone.Sequence((time, value) => {
                        if (!state.isPlaying || !value.note) return;

                        let playDuration = '8n';
                        if (def.type === 'drum') {
                            playDuration = def.release || '8n';
                        } else if (def.type === 'pad') {
                            playDuration = '1n';
                        } else {
                            playDuration = Tone.Time('8n').toSeconds() * (0.5 + this.growth * 0.8);
                        }

                        if (this.instrument && this.instrument.triggerAttackRelease) {
                            this.instrument.triggerAttackRelease(value.note, playDuration, time);
                        }
                        this.bloom = Math.min(1, this.bloom + 0.1);
                        this.grow();
                        this.updateVisuals();
                        this.createBloomParticle(time);

                    }, events).start(0);

                    this.sequence.loop = true;
                    this.sequence.loopEnd = loopEnd;
                    this.sequence.humanize = 0.05;
                }

                grow() {
                    if (this.growth < 1) {
                        this.growth += (0.005 * state.growthRate * this.getWeatherGrowthFactor());
                        this.growth = Math.min(1, this.growth);
                        this.updateVisuals();

                        if (this.instrument && this.instrument.volume) {
                            const targetVolume = -20 + (this.growth * 15);
                            this.instrument.volume.rampTo(targetVolume, 0.1);
                        }
                    }
                }

                water() {
                    this.growth = Math.min(1, this.growth + 0.05);
                    this.updateVisuals();
                    this.createWaterDroplets();
                }

                getWeatherGrowthFactor() {
                    switch (state.currentWeather) {
                        case 'sunny': return 1.2;
                        case 'cloudy': return 0.8;
                        case 'rainy': return 1.5;
                        default: return 1;
                    }
                }

                updateVisuals() {
                    if (!this.domElement) return;

                    const baseHeight = 20;
                    const maxHeightFactor = (80 - this.y) / 60;
                    const stemHeight = baseHeight + (maxHeightFactor * 100 * this.growth);

                    this.stemElement.style.height = `${stemHeight}px`;

                    const headSize = 30 + (this.growth * 30);
                    this.headElement.style.width = `${headSize}px`;
                    this.headElement.style.height = `${headSize}px`;
                    this.headElement.style.bottom = `${stemHeight}px`;
                    this.headElement.style.transform = `translateX(-50%)`;

                    this.headElement.style.filter = `brightness(1 + ${this.bloom * 0.5})`;
                    this.headElement.style.boxShadow = `0 0 ${this.bloom * 15}px ${this.color}`;

                    if (this.bloom > 0) {
                        clearTimeout(this.bloomTimeout);
                        this.bloomTimeout = setTimeout(() => {
                            this.bloom = 0;
                            this.updateVisuals();
                        }, 500);
                    }
                }

                createBloomParticle() {
                    const particle = document.createElement('div');
                    particle.classList.add('particle');
                    const headRect = this.headElement.getBoundingClientRect();
                    const gardenRect = gardenContainer.getBoundingClientRect();
                    particle.style.left = `${(headRect.left + headRect.width / 2 - gardenRect.left)}px`;
                    particle.style.top = `${(headRect.top + headRect.height / 2 - gardenRect.top)}px`;
                    particle.style.width = '8px';
                    particle.style.height = '8px';
                    particle.style.backgroundColor = this.color;
                    bloomParticlesContainer.appendChild(particle);

                    const endX = parseInt(particle.style.left) + (Math.random() - 0.5) * 100;
                    const endY = parseInt(particle.style.top) - Math.random() * 80;
                    particle.animate([
                        { transform: 'translate(0,0) scale(1)', opacity: 1 },
                        { transform: `translate(${endX - parseInt(particle.style.left)}px, ${endY - parseInt(particle.style.top)}px) scale(0.5)`, opacity: 0 }
                    ], {
                        duration: 1000 + Math.random() * 500,
                        easing: 'ease-out',
                        fill: 'forwards'
                    });

                    setTimeout(() => particle.remove(), 1600);
                }

                createWaterDroplets() {
                    const headRect = this.headElement.getBoundingClientRect();
                    const gardenRect = gardenContainer.getBoundingClientRect();
                    for (let i = 0; i < 5; i++) {
                        const droplet = document.createElement('div');
                        droplet.classList.add('water-droplet');
                        droplet.style.left = `${(headRect.left + headRect.width / 2 - gardenRect.left + (Math.random() - 0.5) * 20)}px`;
                        droplet.style.top = `${(headRect.top + headRect.height / 2 - gardenRect.top + (Math.random() - 0.5) * 10)}px`;
                        waterSystemContainer.appendChild(droplet);

                        const endY = parseInt(droplet.style.top) + Math.random() * 50;
                        droplet.animate([
                            { transform: 'translateY(0)', opacity: 1 },
                            { transform: `translateY(${endY - parseInt(droplet.style.top)}px)`, opacity: 0 }
                        ], {
                            duration: 800 + Math.random() * 400,
                            easing: 'ease-in',
                            fill: 'forwards'
                        });
                        setTimeout(() => droplet.remove(), 1200);
                    }
                }

                dispose() {
                    console.log(`Disposing plant ${this.id} (${this.type}).`);
                    if (this.sequence) {
                        this.sequence.dispose();
                    }
                    if (this.instrument && this.def.type !== 'drum') { // Only dispose if not the shared drum sampler
                        this.instrument.dispose();
                    }
                    if (this.domElement) {
                        this.domElement.remove();
                    }
                }

                serialize() {
                    return {
                        id: this.id,
                        type: this.type,
                        x: this.x,
                        y: this.y,
                        growth: this.growth,
                    };
                }
            }

            // --- Core Functions ---

            function selectSeed(seedElement) {
                document.querySelectorAll('.seed').forEach(s => s.classList.remove('selected'));
                seedElement.classList.add('selected');
                state.selectedSeedType = seedElement.dataset.type;
                selectTool(document.getElementById('plant-tool'), 'plant');
                showTooltip(seedElement.title);
            }

            function selectTool(toolElement, toolType) {
                tools.forEach(t => t.classList.remove('active'));
                toolElement.classList.add('active');
                state.activeTool = toolType;
                gardenContainer.dataset.tool = toolType;

                if (toolType !== 'plant') {
                    document.querySelectorAll('.seed').forEach(s => s.classList.remove('selected'));
                    state.selectedSeedType = null;
                }
                showTooltip(toolElement.title);
            }

            function plantNewSeed(event) {
                if (state.activeTool !== 'plant' || !state.selectedSeedType) {
                    return;
                }

                const gardenRect = gardenContainer.getBoundingClientRect();
                const x = ((event.clientX - gardenRect.left) / gardenRect.width) * 100;
                const y = ((event.clientY - gardenRect.top) / gardenRect.height) * 100;

                if (y > 80) {
                    showTooltip("Can't plant on the soil, try above!");
                    return;
                }

                const newPlant = new Plant(state.nextPlantId++, state.selectedSeedType, x, y);
                state.plants.push(newPlant);
                saveGardenState('__autosave__');
                showTooltip(`Planted a ${newPlant.type} seed!`);
            }

            function interactWithPlant(event) {
                const plantElement = event.target.closest('.plant');
                if (!plantElement) return;

                const plantId = parseInt(plantElement.dataset.plantId);
                const plant = state.plants.find(p => p.id === plantId);

                if (!plant) return;

                if (state.activeTool === 'prune') {
                    if (confirm(`Are you sure you want to prune this ${plant.type} plant?`)) {
                        plant.dispose();
                        state.plants = state.plants.filter(p => p.id !== plantId);
                        saveGardenState('__autosave__');
                        showTooltip(`Pruned a ${plant.type} plant.`);
                    }
                } else if (state.activeTool === 'water') {
                    plant.water();
                    saveGardenState('__autosave__');
                    showTooltip(`Watered the ${plant.type} plant!`);
                } else if (state.activeTool === 'select') {
                    alert(`Selected ${plant.type} plant at x:${plant.x.toFixed(2)}, y:${plant.y.toFixed(2)}. Growth: ${(plant.growth*100).toFixed(0)}%`);
                }
            }

            function updateUI() {
                bpmDisplay.textContent = state.bpm;
                scaleDisplay.textContent = state.currentScale;
                growthRateDisplay.textContent = `${state.growthRate.toFixed(1)}x`;
                
                if (bpmSlider) bpmSlider.value = state.bpm;
                if (bpmValue) bpmValue.textContent = state.bpm;
                
                if (masterVolumeSlider) masterVolumeSlider.value = state.masterVolume;
                if (masterVolumeValue) masterVolumeValue.textContent = `${state.masterVolume} dB`;
                
                if (growthRateSlider) growthRateSlider.value = state.growthRate;
                if (growthRateValue) growthRateValue.textContent = `${state.growthRate.toFixed(1)}x`;
                
                gridOverlay.style.display = state.showGrid ? 'block' : 'none';
                if (showGridToggle) showGridToggle.checked = state.showGrid;
                
                const gridToolElement = document.getElementById('grid-toggle');
                if (gridToolElement) gridToolElement.classList.toggle('active', state.showGrid);

                updateToolbarUI();
                updateWeatherUI();
                updateSeasonUI();
            }

            function updateToolbarUI() {
                tools.forEach(tool => {
                    if (tool.dataset.tool === state.activeTool) {
                        tool.classList.add('active');
                    } else {
                        tool.classList.remove('active');
                    }
                });
                gardenContainer.dataset.tool = state.activeTool;
            }

            function updateWeatherUI() {
                weatherOptions.forEach(option => {
                    if (option.dataset.weather === state.currentWeather) {
                        option.classList.add('active');
                    } else {
                        option.classList.remove('active');
                    }
                });
                applyWeatherEffects();
            }

            function updateSeasonUI() {
                seasonOptions.forEach(option => {
                    if (option.dataset.season === state.currentSeason) {
                        option.classList.add('active');
                    } else {
                        option.classList.remove('active');
                    }
                });
                applySeasonEffects();
            }

            let tooltipTimeout;
            function showTooltip(text) {
                tooltip.textContent = text;
                tooltip.style.opacity = 1;
                clearTimeout(tooltipTimeout);
                tooltipTimeout = setTimeout(() => {
                    tooltip.style.opacity = 0;
                }, 2000);
            }

            // --- Weather & Season Effects ---
            function applyWeatherEffects() {
                cloudsContainer.style.opacity = 0;
                rainContainer.style.opacity = 0;
                sunElement.style.opacity = 0;
                sunbeamContainer.style.opacity = 0;
                sunbeamContainer.innerHTML = '';

                switch (state.currentWeather) {
                    case 'sunny':
                        sunElement.style.opacity = 1;
                        for (let i = 0; i < 12; i++) {
                            const beam = document.createElement('div');
                            beam.classList.add('sunbeam');
                            beam.style.position = 'absolute';
                            beam.style.top = '70px';
                            beam.style.right = '70px';
                            beam.style.transformOrigin = `0 50%`;
                            beam.style.transform = `rotate(${i * 30}deg) translateX(-50%)`;
                            beam.style.width = '2px';
                            beam.style.height = '60px';
                            beam.style.background = `linear-gradient(to right, rgba(255, 236, 95, 0.5), rgba(255, 236, 95, 0))`;
                            beam.style.animation = `pulse 2s infinite alternate ${i * 0.1}s`;
                            sunbeamContainer.appendChild(beam);
                        }
                        sunbeamContainer.style.opacity = 0.5;
                        masterReverb.wet.rampTo(0.1, 1);
                        masterDelay.wet.rampTo(0.0, 1);
                        masterFilter.frequency.rampTo(20000, 1);
                        break;
                    case 'cloudy':
                        cloudsContainer.style.opacity = 1;
                        generateClouds();
                        masterReverb.wet.rampTo(0.4, 1);
                        masterDelay.wet.rampTo(0.2, 1);
                        masterFilter.frequency.rampTo(8000, 1);
                        break;
                    case 'rainy':
                        rainContainer.style.opacity = 1;
                        generateRain();
                        masterReverb.wet.rampTo(0.6, 1);
                        masterDelay.wet.rampTo(0.3, 1);
                        masterFilter.frequency.rampTo(3000, 1);
                        break;
                }
            }

            function generateClouds() {
                cloudsContainer.innerHTML = '';
                for (let i = 0; i < 5; i++) {
                    const cloud = document.createElement('div');
                    cloud.classList.add('cloud');
                    cloud.style.width = `${80 + Math.random() * 120}px`;
                    cloud.style.height = `${40 + Math.random() * 60}px`;
                    cloud.style.left = `${-20 + Math.random() * 120}%`;
                    cloud.style.top = `${Math.random() * 60}%`;
                    cloud.style.animation = `float ${10 + Math.random() * 20}s infinite alternate ease-in-out, moveClouds ${40 + Math.random() * 60}s linear infinite`;
                    cloudsContainer.appendChild(cloud);
                }
            }

            function generateRain() {
                rainContainer.innerHTML = '';
                for (let i = 0; i < 100; i++) {
                    const raindrop = document.createElement('div');
                    raindrop.classList.add('raindrop');
                    raindrop.style.left = `${Math.random() * 100}%`;
                    raindrop.style.top = `${Math.random() * 80}%`;
                    raindrop.style.animation = `rainFall ${0.5 + Math.random() * 0.5}s linear infinite`;
                    raindrop.style.animationDelay = `-${Math.random() * 2}s`;
                    rainContainer.appendChild(raindrop);
                }
            }

            function applySeasonEffects() {
                let newScaleType, newTempoFactor, newReverbWet, newDelayWet;
                let baseKey;

                switch (state.currentSeason) {
                    case 'spring':
                        newScaleType = 'major';
                        newTempoFactor = 1.1;
                        newReverbWet = 0.2;
                        newDelayWet = 0.1;
                        baseKey = 'C';
                        break;
                    case 'summer':
                        newScaleType = 'mixolydian';
                        newTempoFactor = 1.0;
                        newReverbWet = 0.3;
                        newDelayWet = 0.2;
                        baseKey = 'G';
                        break;
                    case 'autumn':
                        newScaleType = 'minor';
                        newTempoFactor = 0.9;
                        newReverbWet = 0.4;
                        newDelayWet = 0.3;
                        baseKey = 'A';
                        break;
                    case 'winter':
                        newScaleType = 'phrygian';
                        newTempoFactor = 0.8;
                        newReverbWet = 0.5;
                        newDelayWet = 0.4;
                        baseKey = 'D';
                        break;
                    default:
                        newScaleType = 'major';
                        newTempoFactor = 1.0;
                        newReverbWet = 0.2;
                        newDelayWet = 0.1;
                        baseKey = 'C';
                }

                state.currentScale = `${baseKey} ${newScaleType}`;
                Tone.Transport.bpm.value = state.bpm * newTempoFactor;
                masterReverb.wet.rampTo(newReverbWet, 0.5);
                masterDelay.wet.rampTo(newDelayWet, 0.5);

                state.plants.forEach(plant => {
                    plant.setupSequence();
                });
                updateUI();
            }

            // --- Save/Load Functions ---
            function saveGardenState(gardenName = null) {
                if (!gardenName) {
                    gardenName = saveGardenNameInput.value.trim();
                    if (!gardenName) {
                        alert('Please enter a garden name.');
                        return;
                    }
                }

                const serializedPlants = state.plants.map(p => p.serialize());
                const gardenData = {
                    name: gardenName,
                    date: new Date().toISOString(),
                    bpm: state.bpm,
                    masterVolume: state.masterVolume,
                    growthRate: state.growthRate,
                    currentWeather: state.currentWeather,
                    currentSeason: state.currentSeason,
                    currentScale: state.currentScale,
                    showGrid: state.showGrid,
                    tutorialShown: state.tutorialShown,
                    nextPlantId: state.nextPlantId,
                    plants: serializedPlants,
                };

                try {
                    localStorage.setItem(`botanica_garden_${gardenName}`, JSON.stringify(gardenData));
                    closeModal(saveModal);
                    loadSavedGardensList();
                    showTooltip(`Garden "${gardenName}" saved!`);
                } catch (e) {
                    console.error("Failed to save garden to localStorage:", e);
                    alert("Failed to save garden. Storage might be full or blocked.");
                }
            }

            function loadGardenState(gardenName = '__autosave__') {
                try {
                    const savedData = localStorage.getItem(`botanica_garden_${gardenName}`);
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        
                        state.plants.forEach(p => p.dispose());
                        state.plants = [];

                        state.bpm = data.bpm || 120;
                        state.masterVolume = data.masterVolume || -6;
                        state.growthRate = data.growthRate || 1;
                        state.currentWeather = data.currentWeather || 'sunny';
                        state.currentSeason = data.currentSeason || 'spring';
                        state.currentScale = data.currentScale || 'C Major';
                        state.showGrid = data.showGrid !== undefined ? data.showGrid : true;
                        state.tutorialShown = data.tutorialShown !== undefined ? data.tutorialShown : true;
                        state.nextPlantId = data.nextPlantId || 0;

                        data.plants.forEach(pData => {
                            const newPlant = new Plant(pData.id, pData.type, pData.x, pData.y, { growth: pData.growth });
                            state.plants.push(newPlant);
                        });

                        Tone.Transport.bpm.value = state.bpm;
                        Tone.Destination.volume.value = state.masterVolume;
                        applyWeatherEffects();
                        applySeasonEffects();
                        updateUI();
                        closeModal(loadModal);
                        if (gardenName !== '__autosave__') {
                            showTooltip(`Garden "${gardenName}" loaded!`);
                        }
                    } else if (gardenName === '__autosave__') {
                        updateUI();
                    } else {
                        alert(`No garden found with name "${gardenName}".`);
                    }
                } catch (e) {
                    console.error("Failed to load garden from localStorage:", e);
                    alert("Failed to load garden. Data might be corrupted or inaccessible.");
                }
            }

            function loadSavedGardensList() {
                savedGardensList.innerHTML = '';
                const gardens = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('botanica_garden_') && key !== 'botanica_garden___autosave__') {
                        try {
                            const data = JSON.parse(localStorage.getItem(key));
                            gardens.push(data);
                        } catch (e) {
                            console.error(`Error parsing saved garden data for key "${key}":`, e);
                        }
                    }
                }

                if (gardens.length === 0) {
                    savedGardensList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.7);">No saved gardens yet.</p>';
                    return;
                }

                gardens.sort((a, b) => new Date(b.date) - new Date(a.date));

                gardens.forEach(garden => {
                    const div = document.createElement('div');
                    div.classList.add('saved-garden');
                    div.dataset.gardenName = garden.name;
                    div.innerHTML = `
                        <div class="garden-name">${garden.name}</div>
                        <div class="garden-date">${new Date(garden.date).toLocaleString()}</div>
                    `;
                    div.addEventListener('click', () => loadGardenState(garden.name));
                    savedGardensList.appendChild(div);
                });
            }

            function clearAllSavedGardens() {
                if (confirm('Are you sure you want to delete all saved gardens? This cannot be undone.')) {
                    let clearedCount = 0;
                    for (let i = localStorage.length - 1; i >= 0; i--) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('botanica_garden_')) {
                            localStorage.removeItem(key);
                            clearedCount++;
                        }
                    }
                    loadSavedGardensList();
                    alert(`All ${clearedCount} saved gardens cleared!`);
                    showTooltip('All saved gardens cleared!');
                }
            }

            // --- Modal Functions ---
            function openModal(modalElement) {
                modalElement.classList.add('active');
            }

            function closeModal(modalElement) {
                modalElement.classList.remove('active');
            }

            // --- Grid and Time Markers ---
            function renderGrid() {
                gridOverlay.innerHTML = '';
                const numHorizontal = 8;
                const numVertical = 16;

                for (let i = 0; i <= numHorizontal; i++) {
                    const line = document.createElement('div');
                    line.classList.add('grid-line', 'horizontal-line');
                    line.style.top = `${(i / numHorizontal) * 100}%`;
                    gridOverlay.appendChild(line);
                }

                for (let i = 0; i <= numVertical; i++) {
                    const line = document.createElement('div');
                    line.classList.add('grid-line', 'vertical-line');
                    line.style.left = `${(i / numVertical) * 100}%`;
                    gridOverlay.appendChild(line);
                }
            }

            function renderTimeMarkers() {
                timeMarkersContainer.innerHTML = '';
                const beatsPerMeasure = 4;
                const totalMeasures = 4;
                const totalSteps = beatsPerMeasure * totalMeasures;

                for (let i = 0; i <= totalSteps; i++) {
                    const marker = document.createElement('div');
                    marker.classList.add('time-marker');
                    marker.style.left = `${(i / totalSteps) * 100}%`;
                    timeMarkersContainer.appendChild(marker);

                    if (i % beatsPerMeasure === 0) {
                        const label = document.createElement('div');
                        label.classList.add('time-marker-label');
                        label.textContent = `${i / beatsPerMeasure + 1}m`;
                        label.style.left = `${(i / totalSteps) * 100}%`;
                        timeMarkersContainer.appendChild(label);
                    }
                }
            }

            // --- Ambiance Effects (Butterflies) ---
            function createButterfly() {
                const butterfly = document.createElement('div');
                butterfly.classList.add('butterfly');
                butterfly.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2ZM12 4C14.7614 4 17 6.23858 17 9V12C17 14.7614 14.7614 17 12 17C9.23858 17 7 14.7614 7 12V9C7 6.23858 9.23858 4 12 4Z" fill="currentColor"/>
                    <path d="M12 14.5C13.3807 14.5 14.5 13.3807 14.5 12C14.5 10.6193 13.3807 9.5 12 9.5C10.6193 9.5 9.5 10.6193 9.5 12C9.5 13.3807 10.6193 14.5 12 14.5Z" fill="white"/>
                </svg>`;
                butterfliesContainer.appendChild(butterfly);

                const startX = Math.random() * window.innerWidth;
                const startY = Math.random() * (window.innerHeight * 0.7);
                butterfly.style.left = `${startX}px`;
                butterfly.style.top = `${startY}px`;
                butterfly.style.color = `hsl(${Math.random() * 360}, 70%, 70%)`;

                const flyToNewPosition = () => {
                    const currentX = parseFloat(butterfly.style.left);
                    const currentY = parseFloat(butterfly.style.top);

                    const targetX = Math.random() * (gardenContainer.offsetWidth - 30);
                    const targetY = Math.random() * (gardenContainer.offsetHeight * 0.8 - 30);

                    const dx = targetX - currentX;
                    const dy = targetY - currentY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const duration = Math.max(5000, distance * 50);
                    const angle = Math.atan2(dy, dx) * 180 / Math.PI;

                    butterfly.animate([
                        { transform: `translate(0,0) rotate(${angle}deg)` },
                        { transform: `translate(${dx}px, ${dy}px) rotate(${angle}deg)` }
                    ], {
                        duration: duration,
                        easing: 'linear',
                        fill: 'forwards'
                    }).onfinish = () => {
                        butterfly.style.left = `${targetX}px`;
                        butterfly.style.top = `${targetY}px`;
                        butterfly.style.transform = `none`;
                        flyToNewPosition();
                    };
                };

                flyToNewPosition();
            }

            // --- Event Listeners Setup ---
            playButton.addEventListener('click', togglePlay);

            seedPalette.addEventListener('click', (event) => {
                const seed = event.target.closest('.seed');
                if (seed) {
                    selectSeed(seed);
                }
            });

            toolbar.addEventListener('click', (event) => {
                const tool = event.target.closest('.tool');
                if (tool) {
                    if (tool.id === 'grid-toggle') {
                        state.showGrid = !state.showGrid;
                        updateUI();
                    } else if (tool.id === 'settings-button') {
                        settingsPanel.classList.toggle('active');
                    } else {
                        selectTool(tool, tool.dataset.tool);
                    }
                }
            });

            gardenContainer.addEventListener('click', (event) => {
                if (event.target.closest('.plant')) {
                    interactWithPlant(event);
                } else {
                    plantNewSeed(event);
                }
            });

            saveButton.addEventListener('click', () => {
                openModal(saveModal);
                saveGardenNameInput.value = '';
            });

            loadButton.addEventListener('click', () => {
                loadSavedGardensList();
                openModal(loadModal);
            });

            closeModalButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    const modal = event.target.closest('.modal');
                    if (modal) {
                        closeModal(modal);
                    }
                });
            });

            confirmSaveButton.addEventListener('click', () => saveGardenState());
            clearAllGardensButton.addEventListener('click', clearAllSavedGardens);

            weatherOptions.forEach(option => {
                option.addEventListener('click', () => {
                    state.currentWeather = option.dataset.weather;
                    updateWeatherUI();
                    showTooltip(`Weather changed to: ${state.currentWeather}`);
                });
            });

            seasonOptions.forEach(option => {
                option.addEventListener('click', () => {
                    state.currentSeason = option.dataset.season;
                    updateSeasonUI();
                    showTooltip(`Season changed to: ${state.currentSeason}`);
                });
            });

            if (bpmSlider) {
                bpmSlider.addEventListener('input', () => {
                    state.bpm = parseInt(bpmSlider.value);
                    if (bpmValue) bpmValue.textContent = state.bpm;
                    applySeasonEffects();
                });
            }

            if (masterVolumeSlider) {
                masterVolumeSlider.addEventListener('input', () => {
                    state.masterVolume = parseInt(masterVolumeSlider.value);
                    Tone.Destination.volume.value = state.masterVolume;
                    if (masterVolumeValue) masterVolumeValue.textContent = `${state.masterVolume} dB`;
                });
            }

            if (growthRateSlider) {
                growthRateSlider.addEventListener('input', () => {
                    state.growthRate = parseFloat(growthRateSlider.value);
                    if (growthRateValue) growthRateValue.textContent = `${state.growthRate.toFixed(1)}x`;
                });
            }

            if (showGridToggle) {
                showGridToggle.addEventListener('change', () => {
                    state.showGrid = showGridToggle.checked;
                    gridOverlay.style.display = state.showGrid ? 'block' : 'none';
                    const gridToolElement = document.getElementById('grid-toggle');
                    if (gridToolElement) gridToolElement.classList.toggle('active', state.showGrid);
                });
            }
            

            startGardeningButton.addEventListener('click', () => {
                state.tutorialShown = true;
                closeModal(tutorialModal);
                saveGardenState('__autosave__');
            });

            init();

        });
    </script>
</body>
</html>