<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Botanica - A Brian Eno-inspired Digital Sound Garden</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
  <style>
    :root {
      --bg-color: #0a1f1c;
      --text-color: #e0f4e8;
      --accent-1: #3cc47c; /* Green */
      --accent-2: #1d7373; /* Teal */
      --accent-3: #e9b44c; /* Gold */
      --accent-4: #aa4465; /* Rose */
      --accent-5: #9c7bd6; /* Purple (for Ambient seed) */

      /* Mobile specific variables */
      --mobile-controls-width: 80%; /* Adjust as needed */
    }
    
    body {
      font-family: 'Courier New', monospace;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 0;
      overflow: hidden; /* Prevent body scroll */
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw; /* Ensure full viewport width */
    }
    
    .top-left-fixed-ui {
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 1010; /* High z-index */
      display: flex;
      align-items: center;
      gap: 15px; /* Gap between branding/controls group and mobile toggle */
    }

    .branding-group { /* For mark and text */
      display: flex;
      align-items: center;
      gap: 8px; /* Gap between mark and BOTANICA text */
    }

    /* SVG Logo Placeholder in top-left */
    .svg-logo-placeholder {
      width: 40px; /* Increased size */
      height: 40px; /* Increased size */
      border: 2px solid var(--accent-1); /* Bolder border */
      display: flex;
      flex-direction: column; /* For hamburger lines */
      align-items: center;
      justify-content: space-around; /* Distribute hamburger lines */
      background-color: rgba(var(--accent-1-rgb), 0.05); /* Subtle tint for clarity */
      padding: 8px; /* Padding for hamburger lines */
      box-sizing: border-box;
      cursor: default; /* Default cursor on desktop */
    }

    .hamburger-line {
      display: none; /* Hidden by default, shown on mobile */
      width: 100%;
      height: 3px; /* Slightly thicker lines */
      background-color: var(--accent-1);
      transition: all 0.3s ease-in-out;
      transform-origin: center;
    }

    /* Active state for hamburger to X */
    #logo-menu-toggle.active .hamburger-line:nth-child(1) {
      transform: translateY(8px) rotate(45deg); /* Adjust translate based on line height/padding */
    }
    #logo-menu-toggle.active .hamburger-line:nth-child(2) {
      opacity: 0;
    }
    #logo-menu-toggle.active .hamburger-line:nth-child(3) {
      transform: translateY(-8px) rotate(-45deg); /* Adjust translate */
    }

    .brand-name {
      font-size: 1.3rem;
      font-weight: 500;
      color: var(--text-color);
      letter-spacing: 0.5px;
    }

    .header-garden-controls {
      display: flex;
      gap: 10px; /* Gap between buttons */
      align-items: center; /* Align to center */
    }

    .header-garden-controls button {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 1.6rem; /* Slightly larger for prominence */
      padding: 0.2rem 0.4rem; /* Adjust padding for size */
      cursor: pointer;
      transition: color 0.2s ease;
      line-height: 1; /* Ensure consistent line height */
    }

    .header-garden-controls button:hover {
      color: var(--accent-1);
    }

    main {
      display: flex;
      flex-grow: 1;
      padding: 1rem;
      margin-top: 80px; /* Adjust to clear fixed top-left UI, including brand name */
      margin-right: 280px; /* Adjust to match fixed #controls width on desktop */
      transition: margin-right 0.3s ease-in-out;
    }

    #garden-container {
      flex: 1;
      position: relative;
      overflow: hidden; /* Ensure canvas doesn't overflow */
    }
    
    canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: crosshair;
      touch-action: none; /* Prevent scrolling/zooming on canvas touch */
    }
    
    #controls {
      position: fixed;
      top: 0;
      right: 0;
      width: 280px; /* Or your preferred width */
      height: 100vh;
      background-color: var(--bg-color);
      border-left: 2px solid var(--accent-2);
      box-shadow: -5px 0 15px rgba(0,0,0,0.1);
      padding: 1rem;
      overflow-y: auto; /* Allow scrolling if content exceeds height */
      z-index: 1000;
      transform: translateX(0); /* Always visible on desktop */
      transition: transform 0.3s ease-in-out; /* For mobile slide */
    }

    #controls.open {
      transform: translateY(0); /* Slide into view */
    }

    .control-section {
      background-color: rgba(29, 115, 115, 0.2);
      padding: 1rem;
      border-radius: 6px;
      border: 1px solid var(--accent-2);
    }
    
    .section-title {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-top: 0;
      margin-bottom: 1rem;
      color: var(--accent-1);
      border-bottom: 1px solid var(--accent-1);
      padding-bottom: 0.5rem;
    }
    
    .control-group {
      margin-bottom: 1rem;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }
    
    select, input[type="range"] {
      width: 100%;
      padding: 0.5rem;
      background-color: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--accent-2);
      color: var(--text-color);
      border-radius: 4px;
      -webkit-appearance: none; /* Remove default browser styling for inputs/selects */
      -moz-appearance: none;
      appearance: none;
    }

    /* Style for select dropdown arrow */
    select {
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23e0f4e8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 0.7em top 50%;
      background-size: 0.65em auto;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: var(--accent-1);
      cursor: pointer;
      border: 1px solid var(--text-color);
    }
    
    input[type="range"]::-moz-range-thumb {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: var(--accent-1);
      cursor: pointer;
      border: 1px solid var(--text-color);
    }
    
    button {
      background-color: var(--accent-2);
      color: var(--text-color);
      border: none;
      border-radius: 4px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }
    
    button:hover {
      background-color: var(--accent-1);
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
      background-color: var(--accent-1);
    }
    
    .seed-btn {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
      width: 100%;
      justify-content: space-between;
    }
    
    .seed-btn:before {
      content: "•"; /* Visually separate from seed name */
      margin-right: 0.5rem;
      opacity: 0.6;
    }
    
    .seed-icon {
      width: 20px; /* Slightly smaller */
      height: 20px;
      border-radius: 50%;
      margin-left: 0.5rem;
      border: 1px solid rgba(255,255,255,0.2); /* Subtle border */
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    
    #rhythm-seed .seed-icon { background-color: var(--accent-3); } /* Gold */
    #melody-seed .seed-icon { background-color: var(--accent-1); } /* Green */
    #bass-seed .seed-icon { background-color: var(--accent-2); } /* Teal */
    #ambient-seed .seed-icon { background-color: var(--accent-5); } /* Purple */

    /* Active seed button state */
    .seed-btn.active {
      background-color: var(--accent-1);
      color: var(--bg-color); /* Darker text for contrast */
      font-weight: bold;
    }

    .seed-btn.active .seed-icon {
      border-color: var(--bg-color); /* Match text color */
      box-shadow: 0 0 8px var(--text-color);
    }

    .seed-btn.active:hover {
        background-color: var(--accent-1); /* Keep active color on hover */
    }
    
    .status {
      position: absolute;
      bottom: 1rem; /* Changed to bottom for better visibility on mobile */
      left: 1rem;
      right: 1rem; /* Span full width on mobile */
      background-color: rgba(10, 31, 28, 0.8);
      padding: 0.5rem 1rem;
      border-radius: 4px;
      border: 1px solid var(--accent-2);
      font-size: 0.8rem; /* Slightly smaller */
      pointer-events: none;
      text-align: center; /* Center text on mobile */
      z-index: 2; /* Above canvas */
    }
    
    .environment-btn {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .environment-btn.active {
      background-color: var(--accent-1);
    }

    .environment-btn span {
      font-weight: bold;
      margin-left: 0.5rem;
      color: rgba(255,255,255,0.7);
    }

    .environment-btn.active span {
      color: var(--bg-color);
    }
    
    .slider-value {
      display: inline-block;
      margin-left: 0.5rem;
      width: 2.5rem;
      text-align: right;
    }
    
    #clear-btn {
      background-color: var(--accent-4); /* Rose color */
      margin-top: 1rem;
    }
    
    #clear-btn:hover {
      background-color: #d81159; /* Brighter red on hover */
    }
    
    /* Help Section Styling */
    .help-section details {
      margin-bottom: 0.5rem;
      background-color: rgba(29, 115, 115, 0.1);
      border: 1px solid var(--accent-2);
      border-radius: 4px;
    }
    .help-section summary {
      padding: 0.5rem;
      cursor: pointer;
      font-weight: bold;
      color: var(--accent-1);
      outline: none; /* Remove focus outline for browsers that add it */
    }
    .help-section summary:hover {
      background-color: rgba(29, 115, 115, 0.2);
    }
    .help-section details[open] summary {
      border-bottom: 1px solid var(--accent-2);
    }
    .help-section .help-content {
      padding: 0.5rem 1rem 1rem 1rem;
      font-size: 0.75rem; /* Slightly larger than .info-text for readability */
      line-height: 1.6;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000; /* Below header/controls z-index if they need to be above */
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0s linear 0.3s;
    }
    .modal-overlay.visible {
      opacity: 1;
      visibility: visible;
      transition: opacity 0.3s ease;
    }
    .modal-content {
      background-color: var(--bg-color);
      padding: 2rem;
      border-radius: 8px;
      border: 2px solid var(--accent-1);
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      width: 90%;
      max-width: 500px;
      text-align: left;
    }
    .modal-content h2 {
      color: var(--accent-1);
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }
    .modal-content ul {
      list-style-type: disc;
      padding-left: 20px;
      margin-bottom: 1.5rem;
    }
    .modal-content li {
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    .modal-content button {
      display: block;
      margin: 1rem auto 0 auto;
      padding: 0.6rem 1.2rem;
      background-color: var(--accent-1);
      color: var(--bg-color);
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .modal-content button:hover {
      background-color: var(--accent-3);
      color: var(--text-color);
    }

    /* Mobile specific styles */
    @media (max-width: 768px) {
        main {
            margin-right: 0; /* On mobile, main content takes full width */
            margin-top: 70px; /* Increased top margin for top-left controls and potential wrapping */
        }
        #controls {
            width: 100%; /* Full width on mobile */
            height: auto; /* Adjust height or make it a portion of screen */
            max-height: 60vh; /* Increased max height for mobile controls */
            position: fixed; /* Still fixed */
            top: auto; /* Unset top */
            bottom: 0; /* Stick to bottom on mobile */
            border-left: none;
            border-top: 2px solid var(--accent-2);
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
            z-index: 1000; /* Ensure it's above main content */
        }

        .top-left-fixed-ui {
          flex-wrap: nowrap; /* Try to keep top-left items on one line for mobile */
          width: calc(100% - 1rem); /* Adjusted for new padding */
          box-sizing: border-box;
          justify-content: space-between; /* Distribute space */
          align-items: center; /* Ensure vertical centering of items */
          top: 0.5rem;
          left: 0.5rem;
          right: 0.5rem; /* Ensure it uses available width */
          padding: 0.6rem 0.8rem; /* Increased padding for the bar */
          background-color: rgba(10, 31, 28, 0.8); /* Slightly darker/more opaque */
          border-radius: 8px; /* Slightly more rounded */
          min-height: 50px; /* Ensure decent height for the bar */
        }

        .branding-group {
          gap: 10px; /* Increased gap between logo and text */
        }

        .svg-logo-placeholder {
          width: 38px; height: 38px; /* Fine-tuned mobile size */
          cursor: pointer; /* Clickable on mobile */
          padding: 7px; /* Adjusted padding for hamburger lines */
          border-width: 2px; /* Consistent border */
        }

        .hamburger-line {
            display: block; /* Show hamburger lines on mobile */
        }

        .brand-name {
          font-size: 1.05rem; /* Slightly adjusted size */
        }
        .header-garden-controls {
            margin-left: 10px; /* Ensure some space from branding */
            margin-right: 0; /* Remove right margin if toggle is branding */
            gap: 8px; /* Adjust gap between play/pause/clear */
        }
        .header-garden-controls button {
          font-size: 1.3rem; /* Smaller play/pause/clear on mobile */
          padding: 0.2rem 0.4rem; /* Slightly more padding */
        }
    }
  </style>
</head>
<body>
  <div class="top-left-fixed-ui">
    <div class="branding-group">
      <div class="svg-logo-placeholder" id="logo-menu-toggle">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </div>
      <span class="brand-name">BOTANICA</span>
    </div>
    <div class="header-garden-controls">
        <button id="start-garden-header" title="Start Garden">▶</button>
        <button id="pause-garden-header" title="Pause Garden">❚❚</button>
        <button id="clear-garden-header" title="Clear Garden">✖</button>
    </div>
  </div>
  
  <main>
    <div id="garden-container">
      <canvas id="garden"></canvas>
      <div class="status" id="status-text">Tap to plant. Press SPACE (or Start button) to toggle sound.</div>
    </div>
    
    <div id="controls">
      <div class="control-section">
        <h2 class="section-title">Plant Seeds</h2>
        <div class="control-group">
          <button id="rhythm-seed" class="seed-btn active">Rhythm Seed <span class="seed-icon"></span></button>
          <button id="melody-seed" class="seed-btn">Melody Seed <span class="seed-icon"></span></button>
          <button id="bass-seed" class="seed-btn">Bass Seed <span class="seed-icon"></span></button>
          <button id="ambient-seed" class="seed-btn">Ambient Seed <span class="seed-icon"></span></button>
          <p class="info-text">Select a seed type, then tap/click in the garden to plant.</p>
        </div>
      </div>
      
      <div class="control-section">
        <h2 class="section-title">Environment</h2>
        <div class="control-group">
          <div class="environment-controls">
            <button id="rain-btn" class="environment-btn">Rain (Reverb) <span>Off</span></button>
            <button id="sunshine-btn" class="environment-btn active">Sunshine (Brightness) <span>On</span></button>
            <button id="wind-btn" class="environment-btn">Wind (Modulation) <span>Off</span></button>
          </div>
        </div>
        
        <div class="control-group">
          <label for="season-select">Season (Tonal Shift):</label>
          <select id="season-select">
            <option value="spring">Spring (Major)</option>
            <option value="summer">Summer (Lydian)</option>
            <option value="autumn">Autumn (Minor)</option>
            <option value="winter">Winter (Phrygian)</option>
          </select>
        </div>
      </div>
      
      <div class="control-section">
        <h2 class="section-title">Growth Settings</h2>
        <div class="control-group">
          <label for="growth-speed">Growth Speed: <span class="slider-value" id="growth-speed-value">1.0</span></label>
          <input type="range" id="growth-speed" min="0.5" max="2" step="0.1" value="1">
        </div>
        
        <div class="control-group">
          <label for="density">Growth Density: <span class="slider-value" id="density-value">0.7</span></label>
          <input type="range" id="density" min="0.2" max="1" step="0.1" value="0.7">
        </div>
        
        <div class="control-group">
          <label for="tempo">Garden Tempo: <span class="slider-value" id="tempo-value">110</span></label>
          <input type="range" id="tempo" min="60" max="180" step="1" value="110">
        </div>
      </div>
      
      <div class="control-section help-section">
        <h3 class="section-title">Help & Info</h3>
        <details>
          <summary>Understanding Seed Types</summary>
          <div class="help-content">
            <p>Each seed type generates unique sonic and visual elements. Experiment to discover their character!</p>
            <ul>
              <li><strong>Rhythm:</strong> Focuses on percussive, foundational patterns.</li>
              <li><strong>Melody:</strong> Creates more pitched, flowing musical lines.</li>
              <li><strong>Bass:</strong> Generates deep, resonant foundational tones.</li>
              <li><strong>Ambient:</strong> Produces atmospheric textures and evolving soundscapes.</li>
            </ul>
          </div>
        </details>
        <details>
          <summary>Environmental Effects</summary>
          <div class="help-content">
            <p>These controls alter the garden's atmosphere:</p>
            <ul>
              <li><strong>Rain (Reverb):</strong> Adds spaciousness and echo, like sound reflecting in a large hall.</li>
              <li><strong>Sunshine (Brightness):</strong> Makes the sound brighter and clearer by adjusting an audio filter. Visually, it may illuminate the garden.</li>
              <li><strong>Wind (Modulation):</strong> Introduces subtle movement and detuning to the sound, like a gentle breeze rustling leaves.</li>
            </ul>
          </div>
        </details>
        <details>
          <summary>How Seasons Change the Garden</summary>
          <div class="help-content">
            <p>Changing the season alters the underlying musical scales and color palettes used by the plants, influencing the overall mood and harmony of the garden.</p>
          </div>
        </details>
        <details>
          <summary>Growth, Density & Tempo</summary>
          <div class="help-content">
            <p><strong>Growth Speed:</strong> Controls how quickly plants develop and reach maturity.</p>
            <p><strong>Growth Density:</strong> Influences how many plants can thrive in a given area. Higher density might lead to more complex interactions.</p>
            <p><strong>Garden Tempo (BPM):</strong> Sets the overall speed or 'heartbeat' of the garden's musical events. Measured in Beats Per Minute.</p>
          </div>
        </details>
        <details>
          <summary>Interacting with the Canvas</summary>
          <div class="help-content">
            <p>Click or tap on the main garden area to plant the currently selected seed type. Observe how your actions influence the evolving ecosystem.</p>
          </div>
        </details>
      </div>
    </div>
  </main>

  <div id="quick-start-modal" class="modal-overlay">
    <div class="modal-content">
      <h2>🚀 Quick Start Guide</h2>
      <ul>
        <li><strong>Select a Seed:</strong> Choose a seed type (Rhythm, Melody, etc.) from the panel on the left.</li>
        <li><strong>Plant Your Seed:</strong> Click or tap anywhere on the main Garden canvas to plant.</li>
        <li><strong>Control the Garden:</strong> Use the 'Start', 'Pause', and 'Clear' buttons in the header.</li>
        <li><strong>Experiment:</strong> Adjust Environment (Rain, Sun, Wind) and Growth settings to shape your soundscape!</li>
      </ul>
      <button id="close-quick-start">Got it! Start Exploring</button>
    </div>
  </div>

  <script>
    // --- Constants and Global State ---
    const CANVAS = document.getElementById('garden');
    const CTX = CANVAS.getContext('2d');
    const STATUS_TEXT = document.getElementById('status-text');
    const CONTROLS = document.getElementById('controls');
    const LOGO_MENU_TOGGLE = document.getElementById('logo-menu-toggle'); // New toggle

    let audioInitialized = false;
    let isPlaying = false;
    let plants = [];
    let selectedSeedType = 'rhythm';
    let lastFrameTime = 0;
    let growthSpeed = parseFloat(document.getElementById('growth-speed').value); // Initialize from slider
    let isRaining = false;
    let isSunny = true; // Default sunshine to ON
    let isWindy = false;

    // --- Tone.js Audio Setup ---
    const reverb = new Tone.Reverb({
      decay: 4,
      wet: 0 // Initial wetness
    }).toDestination();
    
    const filter = new Tone.Filter({
      type: "lowpass",
      frequency: 10000 // Initial frequency
    }).connect(reverb);
    
    const chorus = new Tone.Chorus({
      frequency: 1.5,
      delayTime: 3.5,
      depth: 0.7,
      wet: 0 // Initial wetness
    }).connect(filter);
    
    const rhythmSynth = new Tone.MembraneSynth({
      pitchDecay: 0.05,
      octaves: 4,
      oscillator: { type: "square4" },
      envelope: {
        attack: 0.001,
        decay: 0.4,
        sustain: 0.01,
        release: 1.4,
        attackCurve: "exponential"
      }
    }).connect(chorus);
    
    const melodySynth = new Tone.PolySynth(Tone.FMSynth, {
      harmonicity: 2,
      modulationIndex: 1,
      oscillator: { type: "sine" },
      envelope: {
        attack: 0.1,
        decay: 0.2,
        sustain: 0.2,
        release: 1.5,
      },
      modulation: { type: "square" },
      modulationEnvelope: {
        attack: 0.5,
        decay: 0.1,
        sustain: 0.2,
        release: 0.5
      }
    }).connect(chorus);
    
    const bassSynth = new Tone.MonoSynth({
      oscillator: { type: "sawtooth" },
      envelope: {
        attack: 0.1,
        decay: 0.3,
        sustain: 0.4,
        release: 2
      },
      filterEnvelope: {
        attack: 0.001,
        decay: 0.7,
        sustain: 0.1,
        release: 0.8,
        baseFrequency: 200,
        octaves: 4
      }
    }).connect(chorus);
    
    const ambientSynth = new Tone.PolySynth(Tone.AMSynth, {
      harmonicity: 3,
      detune: 0,
      oscillator: { type: "sine" },
      envelope: {
        attack: 1,
        decay: 2,
        sustain: 0.8,
        release: 4
      },
      modulation: { type: "sine" },
      modulationEnvelope: {
        attack: 1,
        decay: 0.5,
        sustain: 0.5,
        release: 4
      }
    }).connect(chorus);

    // --- Plant Class Definition ---
    class Plant {
      constructor(x, y, type, opt = {}) {
        this.x = x;
        this.y = y;
        this.type = type;
        this.age = 0;
        this.maxAge = 100 + Math.random() * 100;
        this.size = 5;
        this.maxSize = 30 + Math.random() * 40;
        this.growthRate = opt.growthSpeed || 1; // Renamed to avoid confusion with global growthSpeed
        this.branches = [];
        this.color = this.getColorByType();
        this.lastNotePlayedTime = 0; // Timestamp for visual glow
        this.active = true;
        
        this.initBranches();
        this.setupToneLoop(); // Setup Tone.Loop for scheduled playback
      }
      
      getColorByType() {
        switch (this.type) {
          case 'rhythm': return 'var(--accent-3)'; // Gold
          case 'melody': return 'var(--accent-1)'; // Green
          case 'bass': return 'var(--accent-2)'; // Teal
          case 'ambient': return 'var(--accent-5)'; // Purple
          default: return '#ffffff';
        }
      }
      
      // Returns Tone.Time strings for loop intervals
      getNoteIntervalByType() {
        switch (this.type) {
          case 'rhythm': return ['8n', '16n'][Math.floor(Math.random() * 2)]; // Faster, more percussive
          case 'melody': return ['4n', '8n.'][Math.floor(Math.random() * 2)]; // Melodic phrases
          case 'bass': return ['1n', '2n'][Math.floor(Math.random() * 2)]; // Slower, foundational
          case 'ambient': return ['2n', '1n', '1n.'][Math.floor(Math.random() * 3)]; // Long, sustained
          default: return '1n';
        }
      }
      
      getScaleBySeason(season) {
        const scales = {
          spring: ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'], // C Major
          summer: ['D4', 'E4', 'F#4', 'G#4', 'A4', 'B4', 'C#5', 'D5'], // D Lydian
          autumn: ['A3', 'C4', 'D4', 'E4', 'G4', 'A4', 'C5', 'D5'], // A Minor Pentatonic / C Major Pentatonic (Eno often uses pentatonic scales)
          winter: ['E3', 'F3', 'G3', 'A3', 'B3', 'C4', 'D4', 'E4'] // E Phrygian
        };
        return scales[season] || scales.spring; // Default to spring
      }

      // Initialize branches for visual representation
      initBranches() {
        const numBranches = 3 + Math.floor(Math.random() * 3);
        for (let i = 0; i < numBranches; i++) {
          const angle = (i * Math.PI * 2 / numBranches) + (Math.random() * 0.5 - 0.25); // Add slight random offset
          const length = this.maxSize * (0.6 + Math.random() * 0.4);
          this.branches.push({
            angle,
            length,
            curve: Math.random() * 0.4 - 0.2, // Curvature of the branch
            nodes: Math.floor(5 + Math.random() * 5) // Number of segments/nodes in branch
          });
        }
      }

      // Setup Tone.Loop for this plant
      setupToneLoop() {
        this.noteLoop = new Tone.Loop(time => {
          if (this.active && isPlaying) { // Only play if active and global playing state is true
            this.playNoteScheduled(time);
          }
        }, this.getNoteIntervalByType());
        this.noteLoop.probability = 0.8; // Add some randomness to note playback
      }

      // Method called by Tone.Loop for precise timing
      playNoteScheduled(time) {
        this.lastNotePlayedTime = Date.now(); // Update for visual glow
        
        const currentSeason = document.getElementById('season-select').value;
        const scale = this.getScaleBySeason(currentSeason);
        
        let note, duration, velocity;
        switch (this.type) {
          case 'rhythm':
            note = scale[Math.floor(Math.random() * 3)]; // Use lower notes for rhythm
            duration = "8n";
            velocity = 0.7 + (Math.random() * 0.3);
            rhythmSynth.triggerAttackRelease(note, duration, time, velocity);
            break;
            
          case 'melody':
            note = scale[Math.floor(Math.random() * scale.length)];
            duration = "4n";
            velocity = 0.5 + (Math.random() * 0.3);
            melodySynth.triggerAttackRelease(note, duration, time, velocity);
            break;
            
          case 'bass':
            note = scale[Math.floor(Math.random() * 3)];
            note = note.replace(/(\d+)/, (match) => parseInt(match) - 1); // Transpose bass notes down an octave
            duration = "2n";
            velocity = 0.6 + (Math.random() * 0.2);
            bassSynth.triggerAttackRelease(note, duration, time, velocity);
            break;
            
          case 'ambient':
            const rootIndex = Math.floor(Math.random() * (scale.length - 2));
            const chord = [
              scale[rootIndex],
              scale[rootIndex + 2],
              scale[rootIndex + 4 % scale.length]
            ];
            duration = "1n"; // Longer duration for ambient chords
            velocity = 0.3 + (Math.random() * 0.2);
            ambientSynth.triggerAttackRelease(chord, duration, time, velocity);
            break;
        }
      }

      startPlayback() {
        this.noteLoop.start(0); // Start immediately
      }

      stopPlayback() {
        this.noteLoop.stop();
      }
      
      grow(delta) {
        if (!this.active) return;
        
        // Growth is scaled by global growthSpeed and individual plant's growthRate
        this.age += delta * growthSpeed * this.growthRate;
        
        if (this.age >= this.maxAge) {
          this.active = false; // Plant "dies" after maxAge
          this.stopPlayback(); // Stop its sound loop
          return;
        }
        
        this.size = Math.min(this.maxSize, 5 + (this.age / this.maxAge) * this.maxSize);
      }
      
      draw(ctx) {
        if (this.size <= 0) return;
        
        // Draw plant core
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size / 3, 0, Math.PI * 2);
        ctx.fillStyle = this.color;
        ctx.fill();
        
        // Draw branches
        this.branches.forEach(branch => {
          this.drawBranch(ctx, branch);
        });
        
        // Add glow effect when playing
        const glowDuration = 200; // ms
        if (isPlaying && Date.now() - this.lastNotePlayedTime < glowDuration) {
          const alpha = 1 - (Date.now() - this.lastNotePlayedTime) / glowDuration;
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size * 1.5, 0, Math.PI * 2);
          ctx.fillStyle = `${this.color}${Math.floor(alpha * 255).toString(16).padStart(2, '0')}`;
          ctx.fill();
        }
      }
      
      drawBranch(ctx, branch) {
        const growthFactor = Math.min(1, this.size / this.maxSize);
        const currentLength = branch.length * growthFactor;
        
        // Calculate points for a smooth curve
        const points = [];
        for (let i = 0; i <= branch.nodes; i++) {
          const t = i / branch.nodes;
          const distance = currentLength * t;
          const angle = branch.angle + (branch.curve * Math.sin(t * Math.PI)); // Sine for smooth curve
          
          const x = this.x + Math.cos(angle) * distance;
          const y = this.y + Math.sin(angle) * distance;
          points.push({ x, y });
        }
        
        // Draw branch curve
        ctx.beginPath();
        ctx.moveTo(this.x, this.y);
        for (let i = 1; i < points.length; i++) {
          const xc = (points[i-1].x + points[i].x) / 2;
          const yc = (points[i-1].y + points[i].y) / 2;
          ctx.quadraticCurveTo(points[i-1].x, points[i-1].y, xc, yc);
        }
        
        ctx.strokeStyle = this.color;
        ctx.lineWidth = Math.max(1, this.size / 10);
        ctx.lineCap = "round";
        ctx.stroke();
        
        // Draw nodes along branch
        for (let i = 1; i < points.length; i++) {
          const nodeSize = Math.max(1, this.size / 6) * (1 - (i / points.length) * 0.5); // Nodes get smaller towards tip
          ctx.beginPath();
          ctx.arc(points[i].x, points[i].y, nodeSize, 0, Math.PI * 2);
          ctx.fillStyle = this.color;
          ctx.fill();
        }
      }
    }

    // --- Canvas and UI Setup ---
    function resizeCanvas() {
      CANVAS.width = CANVAS.parentElement.clientWidth;
      CANVAS.height = CANVAS.parentElement.clientHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas(); // Initial resize

    // UI elements references (already declared in HTML, good practice to get references once)
    const rhythmSeedBtn = document.getElementById('rhythm-seed');
    const melodySeedBtn = document.getElementById('melody-seed');
    const bassSeedBtn = document.getElementById('bass-seed');
    const ambientSeedBtn = document.getElementById('ambient-seed');
    const seedButtons = [rhythmSeedBtn, melodySeedBtn, bassSeedBtn, ambientSeedBtn];

    const playBtn = document.getElementById('play-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const clearBtn = document.getElementById('clear-btn');
    const rainBtn = document.getElementById('rain-btn');
    const sunshineBtn = document.getElementById('sunshine-btn');
    const windBtn = document.getElementById('wind-btn');
    const seasonSelect = document.getElementById('season-select');
    const growthSpeedSlider = document.getElementById('growth-speed');
    const growthSpeedValue = document.getElementById('growth-speed-value');
    const densitySlider = document.getElementById('density');
    const densityValue = document.getElementById('density-value');
    const tempoSlider = document.getElementById('tempo');
    const tempoValue = document.getElementById('tempo-value');

    // --- Event Listeners ---

    // Seed selection
    seedButtons.forEach(btn => {
      btn.addEventListener('click', () => selectSeed(btn.id.replace('-seed', '')));
    });
    function selectSeed(type) {
      selectedSeedType = type;
      seedButtons.forEach(btn => btn.classList.remove('active'));
      document.getElementById(`${type}-seed`).classList.add('active');
      STATUS_TEXT.textContent = `Selected: ${type} seed. Click to plant.`;
    }
    // Initial selection
    selectSeed('rhythm');

    // Environment controls
    rainBtn.addEventListener('click', toggleRain);
    sunshineBtn.addEventListener('click', toggleSunshine);
    windBtn.addEventListener('click', toggleWind);
    
    // Initialize sunshine button state to reflect default
    (() => {
      sunshineBtn.classList.toggle('active', isSunny);
      sunshineBtn.querySelector('span').textContent = isSunny ? 'On' : 'Off';
      filter.frequency.value = isSunny ? 18000 : 10000; // Apply initial filter setting
    })();

    function toggleRain() {
      isRaining = !isRaining;
      rainBtn.classList.toggle('active', isRaining);
      rainBtn.querySelector('span').textContent = isRaining ? 'On' : 'Off';
      reverb.wet.value = isRaining ? 0.6 : 0;
    }
    
    function toggleSunshine() {
      isSunny = !isSunny;
      sunshineBtn.classList.toggle('active', isSunny);
      sunshineBtn.querySelector('span').textContent = isSunny ? 'On' : 'Off';
      filter.frequency.value = isSunny ? 18000 : 10000; // Brighter filter frequency
    }
    
    function toggleWind() {
      isWindy = !isWindy;
      windBtn.classList.toggle('active', isWindy);
      windBtn.querySelector('span').textContent = isWindy ? 'On' : 'Off';
      chorus.wet.value = isWindy ? 0.5 : 0;
    }
    
    // Season control
    seasonSelect.addEventListener('change', updateSeason);
    function updateSeason() {
      const season = seasonSelect.value;
      STATUS_TEXT.textContent = `Season changed to: ${season}. Plants will adapt.`;
    }
    
    // Growth speed slider
    growthSpeedSlider.addEventListener('input', () => {
      growthSpeed = parseFloat(growthSpeedSlider.value);
      growthSpeedValue.textContent = growthSpeed.toFixed(1);
    });
    
    // Density slider
    densitySlider.addEventListener('input', () => {
      densityValue.textContent = densitySlider.value;
    });
    
    // Tempo slider
    tempoSlider.addEventListener('input', () => {
      const tempo = parseInt(tempoSlider.value);
      tempoValue.textContent = tempo;
      if (audioInitialized) { // Only change if audio context is running
        Tone.Transport.bpm.value = tempo;
      }
    });

    // Garden Controls
    const startGardenHeader = document.getElementById('start-garden-header');
    const pauseGardenHeader = document.getElementById('pause-garden-header');
    const clearGardenHeader = document.getElementById('clear-garden-header');

    startGardenHeader.addEventListener('click', startGarden);
    pauseGardenHeader.addEventListener('click', pauseGarden);
    clearGardenHeader.addEventListener('click', clearGarden);
    
    function startGarden() {
      if (!audioInitialized) {
        Tone.start();
        Tone.Transport.start();
        audioInitialized = true;
        STATUS_TEXT.textContent = "Audio initialized. Garden is growing and playing...";
      }
      
      if (!isPlaying) {
        isPlaying = true;
        STATUS_TEXT.textContent = "Garden is growing and playing...";
        Tone.Transport.bpm.value = parseInt(tempoSlider.value);
        plants.forEach(plant => plant.startPlayback()); // Start all plant loops
      }
    }
    
    function pauseGarden() {
      if (isPlaying) {
        isPlaying = false;
        STATUS_TEXT.textContent = "Garden paused. Press SPACE or click Start Garden to resume.";
        plants.forEach(plant => plant.stopPlayback()); // Stop all plant loops
      }
    }
    
    function clearGarden() {
      plants.forEach(plant => plant.stopPlayback()); // Stop all loops first
      plants = [];
      STATUS_TEXT.textContent = "Garden cleared. Plant new seeds!";
      // Also reset environmental effects if desired, or leave them
      // toggleRain(false);
      // toggleSunshine(false);
      // toggleWind(false);
    }
    
    // Canvas click/tap handler
    CANVAS.addEventListener('click', handleCanvasInteraction);
    // Add touch event for better mobile responsiveness for planting
    CANVAS.addEventListener('touchstart', handleCanvasInteraction, {passive: false}); // Prevent default for potential scrolling

    function handleCanvasInteraction(e) {
      if (!audioInitialized) {
        Tone.start();
        Tone.Transport.start();
        audioInitialized = true;
      }
      
      // Get coordinates consistently for mouse or touch
      let clientX, clientY;
      if (e.type === 'touchstart') {
        e.preventDefault(); // Prevent scrolling on touch
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
      } else {
        clientX = e.clientX;
        clientY = e.clientY;
      }

      const rect = CANVAS.getBoundingClientRect();
      const x = clientX - rect.left;
      const y = clientY - rect.top;
      
      const density = parseFloat(densitySlider.value);
      const minDistance = 50 * (1 - density); // Smaller density means closer plants
      
      let tooClose = plants.some(plant => {
        const dx = plant.x - x;
        const dy = plant.y - y;
        return Math.sqrt(dx*dx + dy*dy) < minDistance;
      });
      
      if (!tooClose) {
        const plant = new Plant(x, y, selectedSeedType, { growthSpeed });
        plants.push(plant);
        if (isPlaying) { // If garden is already playing, start new plant's loop
            plant.startPlayback();
        }
        STATUS_TEXT.textContent = `Planted ${selectedSeedType} seed at (${Math.round(x)}, ${Math.round(y)}).`;
      } else {
        STATUS_TEXT.textContent = "Too close to other plants! Adjust density or find more space.";
      }
    }
    
    // Keyboard controls
    window.addEventListener('keydown', (e) => {
      if (e.code === 'Space') {
        e.preventDefault();
        if (isPlaying) {
          pauseGarden();
        } else {
          startGarden();
        }
      }
    });

    // Quick Start Modal Logic
    const quickStartModal = document.getElementById('quick-start-modal');
    const closeQuickStartBtn = document.getElementById('close-quick-start');

    if (quickStartModal && closeQuickStartBtn) {
      window.addEventListener('load', () => {
          quickStartModal.style.display = 'flex';
      });

      closeQuickStartBtn.addEventListener('click', () => {
          quickStartModal.style.display = 'none';
      });
    }

    // Mobile controls toggle logic (now using logo)
    if (LOGO_MENU_TOGGLE && CONTROLS) {
        LOGO_MENU_TOGGLE.addEventListener('click', () => {
            // Only toggle if on mobile (where hamburger is visible and it acts as a button)
            if (window.innerWidth <= 768) {
                CONTROLS.classList.toggle('open'); // Ensure this line is active for menu visibility
                LOGO_MENU_TOGGLE.classList.toggle('active'); // Toggle active class for X animation

                if (CONTROLS.classList.contains('open')) {
                    CANVAS.style.pointerEvents = 'none';
                } else {
                    CANVAS.style.pointerEvents = 'auto';
                }
            }
        });

        CANVAS.addEventListener('click', () => {
            if (window.innerWidth <= 768 && CONTROLS.classList.contains('open')) {
                CONTROLS.classList.remove('open'); // Ensure this line is active for closing menu
                LOGO_MENU_TOGGLE.classList.remove('active'); // Remove active class for X animation
                CANVAS.style.pointerEvents = 'auto'; 
            }
        });
    }

    // --- Visual Effects Drawing Functions ---
    let rainDrops = [];
    function drawRain() {
      // Create new drops
      if (Math.random() < 0.8) { // Adjust frequency
        rainDrops.push({
          x: Math.random() * CANVAS.width,
          y: -10, // Start above canvas
          length: 10 + Math.random() * 20,
          speed: 5 + Math.random() * 10
        });
      }

      CTX.strokeStyle = 'rgba(200, 230, 255, 0.4)'; // Light blue, semi-transparent
      CTX.lineWidth = 1;

      for (let i = 0; i < rainDrops.length; i++) {
        const drop = rainDrops[i];
        
        CTX.beginPath();
        CTX.moveTo(drop.x, drop.y);
        CTX.lineTo(drop.x, drop.y + drop.length);
        CTX.stroke();

        drop.y += drop.speed; // Move down

        // Remove if off-screen
        if (drop.y > CANVAS.height) {
          rainDrops.splice(i, 1);
          i--;
        }
      }
    }

    function drawSunshine() {
      const gradient = CTX.createRadialGradient(
        CANVAS.width * 0.75, CANVAS.height * 0.25, 0, // Inner circle (center, radius)
        CANVAS.width * 0.75, CANVAS.height * 0.25, Math.max(CANVAS.width, CANVAS.height) * 0.6 // Outer circle
      );
      gradient.addColorStop(0, 'rgba(255, 220, 100, 0.1)'); // Bright yellow center
      gradient.addColorStop(0.5, 'rgba(255, 180, 50, 0.05)'); // Orange-yellow fade
      gradient.addColorStop(1, 'rgba(255, 160, 0, 0)'); // Fully transparent at edge

      CTX.fillStyle = gradient;
      CTX.fillRect(0, 0, CANVAS.width, CANVAS.height);
    }

    let windParticles = [];
    function drawWind() {
        // Add new particles occasionally
        if (Math.random() < 0.2) {
            windParticles.push({
                x: Math.random() * CANVAS.width,
                y: Math.random() * CANVAS.height,
                dx: (Math.random() - 0.5) * 5, // Random horizontal movement
                dy: (Math.random() - 0.5) * 2, // Random vertical movement
                life: 60 + Math.random() * 60, // frames
                age: 0,
                size: 1 + Math.random() * 2
            });
        }

        CTX.fillStyle = 'rgba(255, 255, 255, 0.1)'; // Faint white particles

        for (let i = 0; i < windParticles.length; i++) {
            const p = windParticles[i];
            
            // Fade out
            CTX.globalAlpha = (1 - p.age / p.life) * 0.5; // Gradually become more transparent
            CTX.beginPath();
            CTX.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            CTX.fill();
            CTX.globalAlpha = 1; // Reset alpha

            p.x += p.dx;
            p.y += p.dy;
            p.age++;

            if (p.age > p.life) {
                windParticles.splice(i, 1);
                i--;
            }
        }
    }


    // --- Animation Loop ---
    function animate(timestamp) {
      const deltaTime = (timestamp - lastFrameTime) / 1000; // Time in seconds
      lastFrameTime = timestamp;
      
      // Clear canvas
      CTX.clearRect(0, 0, CANVAS.width, CANVAS.height);
      
      // Draw background
      CTX.fillStyle = 'var(--bg-color)';
      CTX.fillRect(0, 0, CANVAS.width, CANVAS.height);
      
      // Update and draw plants
      // Filter out inactive plants for performance
      plants = plants.filter(plant => plant.active);

      plants.forEach(plant => {
        plant.grow(deltaTime); // Growth happens regardless of playing state
        plant.draw(CTX);
      });
      
      // Draw environmental effects
      if (isRaining) {
        drawRain();
      }
      if (isSunny) {
        drawSunshine();
      }
      if (isWindy) {
        drawWind();
      }
      
      requestAnimationFrame(animate);
    }

    // Start the animation loop
    requestAnimationFrame(animate);

    // Initial status text for mobile
    if (window.innerWidth <= 768) {
      STATUS_TEXT.textContent = "Tap to plant. Tap 'Start Garden' to play sound.";
    }
  </script>
</body>
</html>