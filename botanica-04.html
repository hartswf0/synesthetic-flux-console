<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Botanica - Generative Web Sequencer</title>
  <style>
    /* CSS provided by the user, with mobile-first adjustments */
    :root {
      --bg-color: #f0f5e9;
      --text-color: #2a3e26;
      --accent-color: #5a8f5c;
      --light-accent: #a3c9a4;
      --dark-accent: #1e3320;
      --soil-color: #4d3b24;
      --current-weather-color: yellow; /* Default, will be overridden */
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    header {
      background-color: var(--accent-color);
      color: white;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky; /* Make header sticky */
      top: 0;
      z-index: 5; /* Ensure it stays above other content */
    }

    .title {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .title h1 {
      font-weight: 300;
      letter-spacing: 2px;
      font-size: 1.5rem; /* Adjust for mobile */
    }

    .logo {
      width: 40px;
      height: 40px;
    }

    .weather-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .weather-icon {
      width: 24px;
      height: 24px;
      cursor: pointer;
      opacity: 0.6;
      transition: opacity 0.3s;
    }

    .weather-icon:hover, .weather-icon.active {
      opacity: 1;
      color: var(--current-weather-color); /* Highlight active weather */
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative; /* For proper positioning of garden grid steps */
    }

    .toolbar {
      background-color: var(--light-accent);
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
      position: sticky; /* Make toolbar sticky */
      top: 60px; /* Below header (assuming header height 60px) */
      z-index: 4;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Subtle shadow */
    }

    .tool-group {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
    }

    button {
      background-color: var(--dark-accent);
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    button:hover {
      background-color: var(--text-color);
    }
    
    button:active {
      transform: translateY(1px);
    }

    .btn-icon {
      width: 18px;
      height: 18px;
    }

    select, input {
      padding: 0.6rem;
      border: 1px solid var(--light-accent);
      border-radius: 4px;
      background-color: white;
      font-size: 0.9rem;
      min-width: 120px;
    }

    .garden {
      flex: 1;
      position: relative;
      background-color: var(--soil-color);
      overflow: hidden;
      min-height: 400px;
      touch-action: pan-y;
    }

    .grid-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-columns: repeat(16, 1fr);
      grid-template-rows: repeat(8, 1fr);
      opacity: 0.15;
      pointer-events: none;
      z-index: 1;
    }

    .grid-cell {
      border: 1px solid rgba(255, 255, 255, 0.3);
      position: relative;
    }

    .grid-cell.active-step {
        background-color: rgba(255, 255, 255, 0.2);
    }

    .plant {
      position: absolute;
      transform-origin: bottom center;
      transition: transform 0.3s ease-out, filter 0.5s ease-out, opacity 0.3s ease-out;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      z-index: 3;
    }
    
    .plant.selected-for-action {
        outline: 2px dashed var(--dark-accent);
        outline-offset: 3px;
    }

    .plant svg {
      width: 100%;
      height: 100%;
      max-width: 80px;
      max-height: 150px;
      display: block;
    }

    .controls {
      background-color: var(--light-accent);
      padding: 1rem;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    }

    .slider-group {
      display: flex;
      gap: 2rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .slider-control {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      flex: 1;
      min-width: 180px;
      max-width: 300px;
    }

    .slider-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
    }

    .slider-container {
      position: relative;
      height: 10px;
      background-color: var(--bg-color);
      border-radius: 5px;
      cursor: grab;
    }

    .slider-value {
      position: absolute;
      height: 100%;
      background-color: var(--accent-color);
      border-radius: 5px;
      width: 50%;
      pointer-events: none;
    }

    .slider-handle {
      position: absolute;
      width: 20px;
      height: 20px;
      background-color: var(--dark-accent);
      border-radius: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      cursor: grab;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .slider-handle:active {
        cursor: grabbing;
    }

    .transport {
      display: flex;
      gap: 1rem;
      align-items: center;
      justify-content: center;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .season-indicator {
      position: fixed;
      top: calc(1rem + 60px + 1rem);
      right: 1rem;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 5;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 10;
    }

    .modal.active {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-content {
      background-color: var(--bg-color);
      padding: 2rem;
      border-radius: 8px;
      max-width: 90%;
      width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    }

    .modal-content h2 {
        margin-bottom: 1.5rem;
        color: var(--dark-accent);
        text-align: center;
    }

    .seed-selection {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .seed-card {
      background-color: white;
      border-radius: 8px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      border: 2px solid transparent;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .seed-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .seed-card.selected {
        border-color: var(--accent-color);
        box-shadow: 0 0 15px rgba(90, 143, 92, 0.5);
    }

    .seed-icon {
      width: 50px;
      height: 50px;
    }

    .seed-name {
      font-weight: 500;
      text-align: center;
      font-size: 0.9rem;
      color: var(--text-color);
    }

    .album-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .album-entry {
      background-color: white;
      padding: 1rem;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      align-items: flex-start;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .album-entry .album-details {
        flex-grow: 1;
    }

    .album-entry .album-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .album-entry h3 {
        font-size: 1.1rem;
        color: var(--dark-accent);
    }

    .album-entry p {
        font-size: 0.85rem;
        color: var(--text-color);
        opacity: 0.8;
    }

    .album-entry button {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
    }

    .close-btn {
      position: absolute;
      top: 0.8rem;
      right: 0.8rem;
      background: none;
      border: none;
      font-size: 2rem;
      color: var(--text-color);
      cursor: pointer;
      line-height: 1;
      padding: 0;
      min-width: unset;
    }
    
    .close-btn:hover {
        color: var(--accent-color);
        background: none;
    }
    .close-btn:active {
        transform: translateY(0);
    }

    .seasonal-effect {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    .seasonal-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      mix-blend-mode: overlay;
      opacity: 0.3;
      z-index: 2;
      transition: background 1s ease-in-out;
    }

    .spring-overlay {
      background: linear-gradient(120deg, #c9f0d6, #e1f7d0);
    }

    .summer-overlay {
      background: linear-gradient(120deg, #ffd6a5, #ffeb99);
    }

    .autumn-overlay {
      background: linear-gradient(120deg, #ffb347, #ffcc33);
    }

    .winter-overlay {
      background: linear-gradient(120deg, #a5c8e1, #d6e7f0);
    }

    /* Weather specific overlays/effects */
    .rainy-overlay {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10"><path d="M5 0 L5 10" stroke="rgba(170, 200, 255, 0.5)" stroke-width="1.5"/></svg>');
        background-size: 10px 10px;
        animation: rain 0.5s linear infinite;
        pointer-events: none;
        z-index: 4;
        mix-blend-mode: overlay;
    }
    @keyframes rain {
        from { background-position: 0 0; }
        to { background-position: 0 100%; }
    }

    .foggy-overlay {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: linear-gradient(rgba(255,255,255,0) 0%, rgba(255,255,255,0.7) 50%, rgba(255,255,255,0) 100%);
        animation: fog 10s ease-in-out infinite alternate;
        pointer-events: none;
        z-index: 4;
        mix-blend-mode: screen;
        opacity: 0.5;
    }
    @keyframes fog {
        from { transform: translateX(-5%); opacity: 0.5; }
        to { transform: translateX(5%); opacity: 0.7; }
    }

    .windy-effect {
        /* This will be applied via JS to individual plants */
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      header {
        padding: 0.8rem;
      }
      .title h1 {
        font-size: 1.2rem;
      }
      .logo {
        width: 32px;
        height: 32px;
      }
      .weather-icon {
        width: 20px;
        height: 20px;
      }

      .toolbar, .controls {
        flex-direction: column;
        align-items: stretch;
        padding: 0.8rem;
        gap: 0.8rem;
      }
      
      .tool-group {
        justify-content: center;
        gap: 0.8rem;
        flex-wrap: wrap;
      }
      
      button {
        padding: 0.6rem 1rem;
        font-size: 0.85rem;
        min-width: unset;
        flex-grow: 1;
      }
      .btn-icon {
        width: 16px;
        height: 16px;
      }

      select, input {
        padding: 0.6rem;
        font-size: 0.85rem;
        min-width: unset;
        flex-grow: 1;
      }
      
      .slider-group {
        flex-direction: column;
        gap: 1rem;
        align-items: center;
      }
      .slider-control {
          min-width: 90%;
      }

      .transport {
        flex-wrap: wrap;
        gap: 0.8rem;
      }
      
      .season-indicator {
        top: 0.8rem;
        right: 0.8rem;
        padding: 0.4rem 0.8rem;
        font-size: 0.75rem;
      }

      .modal-content {
        padding: 1.5rem;
      }
      .modal-content h2 {
          font-size: 1.3rem;
          margin-bottom: 1rem;
      }
      .seed-selection {
          grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      }
      .seed-card {
          padding: 0.8rem;
      }
      .seed-icon {
          width: 40px;
          height: 40px;
      }
      .seed-name {
          font-size: 0.8rem;
      }
      .album-entry {
        flex-direction: column;
        align-items: stretch;
      }
      .album-entry .album-actions {
          justify-content: flex-end;
      }
      .close-btn {
          font-size: 1.8rem;
          top: 0.5rem;
          right: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="title">
      <svg class="logo" viewBox="0 0 24 24">
        <path fill="currentColor" d="M12,3.5c-4.7,0-8.5,3.8-8.5,8.5s3.8,8.5,8.5,8.5s8.5-3.8,8.5-8.5S16.7,3.5,12,3.5z M12,19.5 c-4.1,0-7.5-3.4-7.5-7.5S7.9,4.5,12,4.5s7.5,3.4,7.5,7.5S16.1,19.5,12,19.5z"/>
        <path fill="currentColor" d="M12,7c0,0-3,2.5-3,5s1.3,4.5,3,4.5s3-2,3-4.5S12,7,12,7z"/>
        <path fill="currentColor" d="M16,9c0,0-2-0.5-2,1s0.9,2.5,2,2.5s2-1,2-2.5S16,9,16,9z"/>
        <path fill="currentColor" d="M8,10c0,0-2-0.5-2,1s0.9,2.5,2,2.5s2-1,2-2.5S8,10,8,10z"/>
      </svg>
      <h1>Botanica</h1>
    </div>
    <div class="weather-controls">
      <svg class="weather-icon" id="weather-sunny" viewBox="0 0 24 24">
        <path fill="currentColor" d="M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5S14.76,7,12,7L12,7z M2,13h2c0.55,0,1-0.45,1-1 s-0.45-1-1-1H2c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13h2c0.55,0,1-0.45,1-1s-0.45-1-1-1h-2c-0.55,0-1,0.45-1,1 S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1 s1-0.45,1-1v-2c0-0.55-0.45-1-1-1S11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41 l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41L18.36,16.95z M19.42,5.99 c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L7.05,18.36z"/>
      </svg>
      <svg class="weather-icon" id="weather-rainy" viewBox="0 0 24 24">
        <path fill="currentColor" d="M13.127,22.259a.75.75,0,0,1-.627-.336l-2.248-3.75a.75.75,0,0,1,1.248-.834l2.25,3.75a.75.75,0,0,1-.623,1.17Z"/>
        <path fill="currentColor" d="M17.127,22.259a.75.75,0,0,1-.627-.336l-2.248-3.75a.75.75,0,0,1,1.248-.834l2.25,3.75a.75.75,0,0,1-.623,1.17Z"/>
        <path fill="currentColor" d="M9.127,22.259a.75.75,0,0,1-.627-.336l-2.248-3.75a.75.75,0,0,1,1.248-.834l2.25,3.75a.75.75,0,0,1-.623,1.17Z"/>
        <path fill="currentColor" d="M16.752,14.022a5.5,5.5,0,0,0,.327-10.97A8.017,8.017,0,0,0,1.3,8.7a5,5,0,0,0,.858,9.93h14.6a.75.75,0,0,0,0-1.5h-14.6a3.5,3.5,0,1,1,.145-6.994.714.714,0,0,0,.755-.351,6.517,6.517,0,0,1,12.267.351.7.7,0,0,0,.736.344,4,4,0,0,1,.692-.061,4,4,0,0,1,0,8,3.878,3.878,0,0,1-.441-.025.75.75,0,0,0-.166,1.49,5.407,5.407,0,0,0,.607.035A5.5,5.5,0,0,0,16.752,14.022Z"/>
      </svg>
      <svg class="weather-icon" id="weather-foggy" viewBox="0 0 24 24">
        <path fill="currentColor" d="M19.84,10.76A7,7,0,0,0,6.16,10.76,4.94,4.94,0,0,0,2,15.58a5,5,0,0,0,5,5h10a5,5,0,0,0,5-5A4.94,4.94,0,0,0,19.84,10.76ZM17,19.08H7a3.5,3.5,0,0,1-.11-7,.75.75,0,0,0,.69-.62,5.5,5.5,0,0,1,10.84,0,.75.75,0,0,0,.69.62,3.5,3.5,0,0,1-.11,7Z"/>
        <path fill="currentColor" d="M8.49,15.2H19.35a.75.75,0,0,0,0-1.5H8.49a.75.75,0,0,0,0,1.5Z"/>
        <path fill="currentColor" d="M5.49,15.2H6.22a.75.75,0,0,0,0-1.5H5.49a.75.75,0,0,0,0,1.5Z"/>
        <path fill="currentColor" d="M15.74,18H4.88a.75.75,0,0,0,0,1.5H15.74a.75.75,0,0,0,0-1.5Z"/>
        <path fill="currentColor" d="M18.74,18H18a.75.75,0,0,0,0,1.5h.74a.75.75,0,0,0,0-1.5Z"/>
      </svg>
      <svg class="weather-icon" id="weather-windy" viewBox="0 0 24 24">
        <path fill="currentColor" d="M13,5.5H3.5a.75.75,0,0,1,0-1.5H13a1,1,0,0,0,0-2,1,1,0,0,0-1-1,.75.75,0,0,1,0-1.5,2.5,2.5,0,0,1,0,5Z"/>
        <path fill="currentColor" d="M11.5,24a2.5,2.5,0,0,1,0-5H21a.75.75,0,0,1,0,1.5H11.5a1,1,0,0,0,0,2,1,1,0,0,0,1,1,.75.75,0,0,1,0,1.5A1,1,0,0,1,11.5,24Z"/>
        <path fill="currentColor" d="M15.5,12a3,3,0,0,1,0-6h5a.75.75,0,0,1,0,1.5h-5a1.5,1.5,0,0,0,0,3h6a1,1,0,0,1,0,2h-5.5a.75.75,0,0,1,0-1.5h5.5a.25.25,0,0,0,0-.5h-6Z"/>
        <path fill="currentColor" d="M17.5,18A1.5,1.5,0,0,1,16,16.5H3.5a.75.75,0,0,1,0-1.5H16a3,3,0,0,1,0,6H12.5a.75.75,0,0,1,0-1.5H16A1.5,1.5,0,0,0,17.5,18Z"/>
        <path fill="currentColor" d="M6.5,12A1.5,1.5,0,0,1,5,10.5H3.5a.75.75,0,0,1,0-1.5H5a3,3,0,0,1,0,6H5a.75.75,0,0,1,0-1.5A1.5,1.5,0,0,0,6.5,12Z"/>
      </svg>
    </div>
  </header>

  <main>
    <div class="toolbar">
      <div class="tool-group">
        <button id="plant-seed-btn">
          <svg class="btn-icon" viewBox="0 0 24 24">
            <path fill="currentColor" d="M20,12c0-4.42-3.58-8-8-8s-8,3.58-8,8s3.58,8,8,8S20,16.42,20,12z M13,17h-2v-6h2V17z M13,9h-2V7h2V9z"/>
          </svg>
          Plant Seed
        </button>
        <button id="prune-btn">
          <svg class="btn-icon" viewBox="0 0 24 24">
            <path fill="currentColor" d="M19,3L13,9L15,11L22,4V3M12,12.5A0.5,0.5 0 0,1 11.5,12A0.5,0.5 0 0,1 12,11.5A0.5,0.5 0 0,1 12.5,12A0.5,0.5 0 0,1 12,12.5M6,20A2,2 0 0,1 4,18C4,16.89 4.9,16 6,16A2,2 0 0,1 8,18C8,19.11 7.1,20 6,20M6,8A2,2 0 0,1 4,6C4,4.89 4.9,4 6,4A2,2 0 0,1 8,6C8,7.11 7.1,8 6,8M9.64,7.64C9.87,7.14 10,6.59 10,6A4,4 0 0,0 6,2A4,4 0 0,0 2,6A4,4 0 0,0 6,10C6.59,10 7.14,9.87 7.64,9.64L10,12L7.64,14.36C7.14,14.13 6.59,14 6,14A4,4 0 0,0 2,18A4,4 0 0,0 6,22A4,4 0 0,0 10,18C10,17.41 9.87,16.86 9.64,16.36L12,14L19,21H22V20L9.64,7.64Z"/>
          </svg>
          Prune
        </button>
        <button id="water-btn">
          <svg class="btn-icon" viewBox="0 0 24 24">
            <path fill="currentColor" d="M12,20A6,6 0 0,1 6,14C6,10 12,3.25 12,3.25C12,3.25 18,10 18,14A6,6 0 0,1 12,20Z"/>
          </svg>
          Water
        </button>
        <button id="wild-growth-btn">
          <svg class="btn-icon" viewBox="0 0 24 24">
            <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15H9v-2h2v2zm0-4H9v-2h2v2zm0-4H9V7h2v2zm4 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2z"/>
          </svg>
          Wild Growth
        </button>
      </div>

      <div class="tool-group">
        <select id="season-select">
          <option value="spring">Spring</option>
          <option value="summer">Summer</option>
          <option value="autumn">Autumn</option>
          <option value="winter">Winter</option>
        </select>
        
        <button id="save-album-btn">
          <svg class="btn-icon" viewBox="0 0 24 24">
            <path fill="currentColor" d="M12,11A1,1 0 0,0 11,12A1,1 0 0,0 12,13A1,1 0 0,0 13,12A1,1 0 0,0 12,11M12,16.5C9.5,16.5 7.5,14.5 7.5,12C7.5,9.5 9.5,7.5 12,7.5C14.5,7.5 16.5,9.5 16.5,12C16.5,14.5 14.5,16.5 12,16.5M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>
          </svg>
          Save to Album
        </button>
        
        <button id="view-albums-btn">
          <svg class="btn-icon" viewBox="0 0 24 24">
            <path fill="currentColor" d="M12,16A3,3 0 0,1 9,13C9,11.88 9.61,10.9 10.5,10.39L20.21,4.77L14.68,14.35C14.18,15.33 13.17,16 12,16M12,3C13.81,3 15.5,3.5 16.97,4.32L14.87,5.53C14,5.19 13,5 12,5A8,8 0 0,0 4,13C4,15.21 4.89,17.21 6.34,18.65H6.35C6.74,19.04 6.74,19.67 6.35,20.06C5.96,20.45 5.32,20.45 4.93,20.07V20.07C3.12,18.26 2,15.76 2,13A10,10 0 0,1 12,3M22,13C22,15.76 20.88,18.26 19.07,20.07V20.07C18.68,20.45 18.05,20.45 17.66,20.06C17.27,19.67 17.27,19.04 17.66,18.65V18.65C19.11,17.2 20,15.21 20,13C20,12 19.81,11 19.46,10.1L20.67,8C21.5,9.5 22,11.18 22,13Z"/>
          </svg>
          View Albums
        </button>
      </div>
    </div>
    
    <div class="garden" id="garden">
      <div class="grid-overlay" id="grid-overlay"></div>
      <div class="seasonal-effect" id="seasonal-effect"></div>
      <div class="seasonal-overlay spring-overlay" id="seasonal-overlay"></div>
      <div class="weather-overlay" id="weather-overlay"></div>
    </div>
    
    <div class="controls">
      <div class="slider-group">
        <div class="slider-control">
          <div class="slider-label">
            <span>Growth Rate</span>
            <span id="growth-rate-value">50%</span>
          </div>
          <div class="slider-container" id="growth-rate-slider">
            <div class="slider-value" id="growth-rate-slider-value"></div>
            <div class="slider-handle" id="growth-rate-handle"></div>
          </div>
        </div>
        
        <div class="slider-control">
          <div class="slider-label">
            <span>Moisture</span>
            <span id="moisture-value">50%</span>
          </div>
          <div class="slider-container" id="moisture-slider">
            <div class="slider-value" id="moisture-slider-value"></div>
            <div class="slider-handle" id="moisture-handle"></div>
          </div>
        </div>
        
        <div class="slider-control">
          <div class="slider-label">
            <span>Sunlight</span>
            <span id="sunlight-value">50%</span>
          </div>
          <div class="slider-container" id="sunlight-slider">
            <div class="slider-value" id="sunlight-slider-value"></div>
            <div class="slider-handle" id="sunlight-handle"></div>
          </div>
        </div>
      </div>
      
      <div class="transport">
        <button id="play-btn">
          <svg class="btn-icon" viewBox="0 0 24 24">
            <path fill="currentColor" d="M8,5.14V19.14L19,12.14L8,5.14Z"/>
          </svg>
          Play
        </button>
        <button id="stop-btn">
          <svg class="btn-icon" viewBox="0 0 24 24">
            <path fill="currentColor" d="M18,18H6V6H18V18Z"/>
          </svg>
          Stop
        </button>
        <select id="tempo-select">
          <option value="60">60 BPM</option>
          <option value="80">80 BPM</option>
          <option value="100" selected>100 BPM</option>
          <option value="120">120 BPM</option>
          <option value="140">140 BPM</option>
          <option value="160">160 BPM</option>
        </select>
      </div>
    </div>
  </main>
  
  <div class="season-indicator" id="season-indicator">
    <svg id="season-icon" viewBox="0 0 24 24" width="16" height="16">
      <!-- Icon will be dynamically updated based on season -->
      <path fill="currentColor" d="M12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8C14.21,8 16,9.79 16,12C16,14.21 14.21,16 12,16M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>
    </svg>
    <span id="current-season-text">Spring</span>
  </div>

  <!-- Plant Seed Modal -->
  <div id="plant-seed-modal" class="modal">
    <div class="modal-content">
      <button class="close-btn" data-modal="plant-seed-modal">×</button>
      <h2>Choose a Seed to Plant</h2>
      <div class="seed-selection" id="seed-selection-container">
        <!-- Seed cards will be dynamically inserted here -->
      </div>
      <div style="text-align: right; margin-top: 1rem;">
          <button id="confirm-seed-btn" style="background-color: var(--accent-color);">
            <svg class="btn-icon" viewBox="0 0 24 24">
                <path fill="currentColor" d="M9,20.41L2.79,14.21L5.62,11.38L9,14.75L18.38,5.38L21.21,8.21L9,20.41Z" />
            </svg>
            Select Seed
          </button>
      </div>
    </div>
  </div>

  <!-- View Albums Modal -->
  <div id="view-albums-modal" class="modal">
    <div class="modal-content">
      <button class="close-btn" data-modal="view-albums-modal">×</button>
      <h2>Botanical Albums</h2>
      <div class="album-container" id="album-list-container">
        <!-- Album entries will be dynamically inserted here -->
        <p id="no-albums-message" style="text-align: center; color: var(--text-color); opacity: 0.7;">No albums saved yet.</p>
      </div>
    </div>
  </div>

  <!-- Tone.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.min.js"></script>
  <script>
    // --- Global State ---
    let plants = []; // Stores { id, type, row, col, growth, health, instrument, individualReverb, individualDelay }
    let currentSeason = 'spring';
    let currentWeather = 'sunny'; // 'sunny', 'rainy', 'foggy', 'windy'
    let environment = { growthRate: 0.5, moisture: 0.5, sunlight: 0.5 };
    let tempo = 100; // BPM
    let isPlaying = false;
    let activeTool = 'plant'; // 'plant', 'prune', 'water'
    let selectedSeedType = null; // Used for the plant seed modal
    let botanicalAlbums = []; // Stores saved garden states
    let currentStep = 0; // Sequencer step
    const GRID_COLS = 16;
    const GRID_ROWS = 8;
    const LOCAL_STORAGE_KEY = 'botanicaAlbums';

    // Tone.js variables (initialized in initAudio)
    let masterReverb;
    let masterDelay;
    let masterEQ;
    let sequencer;
    let audioInitialized = false; // Flag to prevent re-initialization

    // Tone.js instruments (for effects like watering)
    const instruments = {};

    // --- DOM Elements ---
    const gardenDiv = document.getElementById('garden');
    const gridOverlay = document.getElementById('grid-overlay');
    const seasonalOverlay = document.getElementById('seasonal-overlay');
    const weatherOverlay = document.getElementById('weather-overlay'); // New element for weather effects
    const seasonIndicatorText = document.getElementById('current-season-text');
    const seasonIndicatorIcon = document.getElementById('season-icon');

    const plantSeedBtn = document.getElementById('plant-seed-btn');
    const pruneBtn = document.getElementById('prune-btn');
    const waterBtn = document.getElementById('water-btn');
    const wildGrowthBtn = document.getElementById('wild-growth-btn'); // New button
    const seasonSelect = document.getElementById('season-select');
    const saveAlbumBtn = document.getElementById('save-album-btn');
    const viewAlbumsBtn = document.getElementById('view-albums-btn');
    const playBtn = document.getElementById('play-btn');
    const stopBtn = document.getElementById('stop-btn');
    const tempoSelect = document.getElementById('tempo-select');

    const weatherIcons = document.querySelectorAll('.weather-icon');
    const growthRateHandle = document.getElementById('growth-rate-handle');
    const moistureHandle = document.getElementById('moisture-handle');
    const sunlightHandle = document.getElementById('sunlight-handle');
    const growthRateValueSpan = document.getElementById('growth-rate-value');
    const moistureValueSpan = document.getElementById('moisture-value');
    const sunlightValueSpan = document.getElementById('sunlight-value');
    const growthRateSliderValueDiv = document.getElementById('growth-rate-slider-value');
    const moistureSliderValueDiv = document.getElementById('moisture-slider-value');
    const sunlightSliderValueDiv = document.getElementById('sunlight-slider-value');

    const plantSeedModal = document.getElementById('plant-seed-modal');
    const viewAlbumsModal = document.getElementById('view-albums-modal');
    const seedSelectionContainer = document.getElementById('seed-selection-container');
    const albumListContainer = document.getElementById('album-list-container');
    const confirmSeedBtn = document.getElementById('confirm-seed-btn');
    const noAlbumsMessage = document.getElementById('no-albums-message');

    // --- Seed Definitions (Plant Types) ---
    const seedTypes = [
      {
        id: 'synth-bell', name: 'Synth Bell',
        svg: `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`,
        instrumentType: 'Synth',
        synthOptions: { oscillator: { type: 'sine' }, envelope: { attack: 0.05, decay: 0.5, sustain: 0.1, release: 0.5 }, volume: -12 }
      },
      {
        id: 'pluck-string', name: 'Pluck String',
        svg: `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 22s-8-4-8-10c0-4.41 3.59-8 8-8s8 3.59 8 8c0 6-8 10-8 10zM12 4c-3.31 0-6 2.69-6 6 0 3.33 4.81 7.7 6 9.33 1.19-1.63 6-6 6-9.33 0-3.31-2.69-6-6-6z"/><path fill="currentColor" d="M12 13c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z"/></svg>`,
        instrumentType: 'PluckSynth',
        synthOptions: { attackNoise: 0.5, dampening: 4000, resonance: 0.9, envelope: { attack: 0.005, decay: 0.3, sustain: 0.1, release: 0.5 }, volume: -10 }
      },
      {
        id: 'drum-percussion', name: 'Drum Beat',
        svg: `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9-4.03-9-9-9zm0 16c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7zm-2-9c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm6 0c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-4 4c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>`,
        instrumentType: 'MembraneSynth',
        synthOptions: { pitchDecay: 0.05, envelope: { attack: 0.005, decay: 0.4, sustain: 0.01, release: 0.2 }, octaves: 8, volume: -8 }
      },
      {
        id: 'ambient-pad', name: 'Ambient Pad',
        svg: `<svg viewBox="0 0 24 24"><path fill="currentColor" d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6Z"/></svg>`,
        instrumentType: 'PolySynth',
        synthOptions: { polyphony: 4, voice: Tone.Synth, options: { oscillator: { type: 'triangle' }, envelope: { attack: 1, decay: 2, sustain: 0.5, release: 3 } }, volume: -15 }
      }
    ];

    // --- Utility Functions ---
    function uuidv4() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function lerp(a, b, t) {
        return a + (b - a) * t;
    }

    function clamp(value, min, max) {
        return Math.max(min, Math.min(value, max));
    }

    // --- Modal Handlers ---
    function openModal(modalElement) {
        modalElement.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent background scroll
    }

    function closeModal(modalElement) {
        modalElement.classList.remove('active');
        document.body.style.overflow = '';
        if (modalElement.id === 'plant-seed-modal') {
            // Deselect any selected seed
            const currentSelected = seedSelectionContainer.querySelector('.seed-card.selected');
            if (currentSelected) {
                currentSelected.classList.remove('selected');
            }
            selectedSeedType = null;
        }
    }

    // Attach click listeners to all close buttons
    document.querySelectorAll('.close-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const modalId = e.target.dataset.modal;
            const modal = document.getElementById(modalId);
            if (modal) closeModal(modal);
        });
    });

    // Close modal if clicked outside content
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal(modal);
            }
        });
    });

    // --- Slider Logic ---

    // Helper to update slider visuals without touching event listeners
    function updateSliderDisplay(propertyName) {
        const value = environment[propertyName];
        // Convert camelCase propertyName to kebab-case for DOM element IDs
        const kebabCasePropertyName = propertyName.replace(/([A-Z])/g, '-$1').toLowerCase();

        const valueDisplay = document.getElementById(`${kebabCasePropertyName}-value`);
        const valueBar = document.getElementById(`${kebabCasePropertyName}-slider-value`);
        const handle = document.getElementById(`${kebabCasePropertyName}-handle`);
        const sliderContainer = handle?.parentElement; // Get the container for calculations

        if (valueDisplay && valueBar && handle && sliderContainer) {
            valueDisplay.textContent = `${Math.round(value * 100)}%`;
            valueBar.style.width = `${value * 100}%`;
            // Calculate handle position relative to the container's width
            handle.style.left = `${value * 100}%`;
        }
    }

    function setupSlider(handle, propertyName) {
        let isDragging = false;
        const sliderContainer = handle.parentElement; 

        // This internal function updates the environment state and calls the display helper
        const updateSliderValueAndDisplay = (value) => {
            const clampedValue = clamp(value, 0, 1);
            environment[propertyName] = clampedValue; // Update the global environment state
            updateSliderDisplay(propertyName); // Update visuals using the helper
            updateAllPlantVisualsAndSounds(); // Update dependent visuals/sounds
        };

        const onMove = (event) => {
            if (!isDragging) return;
            const clientX = event.touches ? event.touches[0].clientX : event.clientX;
            const rect = sliderContainer.getBoundingClientRect(); // Get container dimensions
            let newX = clientX - rect.left; // Calculate position within container
            let percent = newX / rect.width; // Convert to percentage (0 to 1)
            updateSliderValueAndDisplay(percent); // Update value and display
            event.preventDefault(); // Prevent scrolling while dragging on touch devices
        };

        const onEnd = () => {
            isDragging = false;
            handle.style.cursor = 'grab';
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onEnd);
            document.removeEventListener('touchmove', onMove);
            document.removeEventListener('touchend', onEnd);
        };

        const onStart = (event) => {
            isDragging = true;
            handle.style.cursor = 'grabbing';
            // Attach global listeners so dragging outside the handle still works
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onEnd);
            document.addEventListener('touchmove', onMove, { passive: false }); // passive: false to allow preventDefault
            document.addEventListener('touchend', onEnd);
            onMove(event); // Initial update on click/tap, also sets initial position
            event.preventDefault(); // Prevent default touch behavior (e.g., long press menu)
        };

        // Attach event listeners for mouse and touch interactions to the handle itself
        handle.addEventListener('mousedown', onStart);
        handle.addEventListener('touchstart', onStart, { passive: false }); // passive: false to allow preventDefault
    }


    // --- Weather & Season ---
    function setSeason(season) {
        currentSeason = season;
        seasonalOverlay.className = `seasonal-overlay ${season}-overlay`;
        seasonIndicatorText.textContent = season.charAt(0).toUpperCase() + season.slice(1);
        
        // Update icon based on season (example, can be more elaborate)
        let seasonIconPath;
        switch (season) {
            case 'spring': seasonIconPath = 'M12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8C14.21,8 16,9.79 16,12C16,14.21 14.21,16 12,16M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z'; break; // Placeholder sun
            case 'summer': seasonIconPath = 'M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5S14.76,7,12,7L12,7z M2,13h2c0.55,0,1-0.45,1-1 s-0.45-1-1-1H2c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13h2c0.55,0,1-0.45,1-1s-0.45-1-1-1h-2c-0.55,0-1,0.45-1,1 S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1 s1-0.45,1-1v-2c0-0.55-0.45-1-1-1S11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41 l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41L18.36,16.95z M19.42,5.99 c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L7.05,18.36z'; break; // Sunny
            case 'autumn': seasonIconPath = 'M16.14,13.38L10.5,18.91L5.3,13.7L6.71,12.29L10.5,16.07L14.73,11.84L16.14,13.38M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z'; break; // Leaf-like shape
            case 'winter': seasonIconPath = 'M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z'; break; // Simple shape for winter
        }
        seasonIndicatorIcon.innerHTML = `<path fill="currentColor" d="${seasonIconPath}"/>`;

        // Update sound effects (e.g., master EQ/reverb settings)
        updateAllPlantVisualsAndSounds();
        updateMasterFX(); // Call only if audio is initialized
    }

    function setWeather(weather) {
        currentWeather = weather;
        weatherOverlay.innerHTML = ''; // Clear previous weather effects
        weatherOverlay.className = 'weather-overlay';

        // Update weather icon visuals
        weatherIcons.forEach(icon => {
            icon.classList.remove('active');
            icon.style.setProperty('--current-weather-color', ''); // Reset specific color
            if (icon.id === `weather-${weather}`) {
                icon.classList.add('active');
                let color;
                switch(weather) {
                    case 'sunny': color = 'orange'; break;
                    case 'rainy': color = '#AACCFF'; break;
                    case 'foggy': color = '#E0E0E0'; break;
                    case 'windy': color = '#A0D0A0'; break;
                }
                icon.style.setProperty('--current-weather-color', color);
            }
        });

        // Apply visual overlays
        if (weather === 'rainy') {
            weatherOverlay.classList.add('rainy-overlay');
        } else if (weather === 'foggy') {
            weatherOverlay.classList.add('foggy-overlay');
        }
        // Windy effects will be applied to individual plants

        // Update sound effects (e.g., master EQ/reverb settings)
        updateAllPlantVisualsAndSounds();
        updateMasterFX(); // Call only if audio is initialized
    }

    // Attach event listeners for weather icons
    weatherIcons.forEach(icon => {
        icon.addEventListener('click', () => {
            const weatherType = icon.id.replace('weather-', '');
            setWeather(weatherType);
        });
    });

    // Attach event listener for season select
    seasonSelect.addEventListener('change', (e) => setSeason(e.target.value));

    // --- Garden & Plant Management ---
    function renderGarden() {
        // Clear existing plants
        document.querySelectorAll('.plant').forEach(p => p.remove());

        plants.forEach(plant => {
            const plantEl = document.createElement('div');
            plantEl.className = 'plant';
            plantEl.dataset.plantId = plant.id;
            plantEl.dataset.row = plant.row;
            plantEl.dataset.col = plant.col;
            const seedSvg = seedTypes.find(s => s.id === plant.type)?.svg;
            if (seedSvg) {
              plantEl.innerHTML = seedSvg;
            } else {
              console.warn(`SVG for seed type "${plant.type}" not found. Plant ID: ${plant.id}`);
              // Provide a default placeholder or skip
              plantEl.innerHTML = `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="gray"/></svg>`; 
            }

            // Position plant based on grid
            // Ensure gardenDiv has a valid size before calculating cellSize
            const gardenRect = gardenDiv.getBoundingClientRect();
            const cellSizeWidth = gardenRect.width / GRID_COLS;
            const cellSizeHeight = gardenRect.height / GRID_ROWS;

            plantEl.style.left = `${plant.col * cellSizeWidth}px`;
            plantEl.style.top = `${plant.row * cellSizeHeight}px`;
            plantEl.style.width = `${cellSizeWidth}px`;
            // Plant height will be adjusted by scaleY in updatePlantVisuals based on growth
            plantEl.style.height = `${cellSizeHeight * 1.5}px`; // Base height for positioning


            // Add click listener for pruning/watering
            plantEl.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent garden click
                if (activeTool === 'prune') {
                    if (confirm(`Are you sure you want to prune this ${plant.type}?`)) {
                        prunePlant(plant.id);
                    }
                } else if (activeTool === 'water') {
                    waterPlant(plant.id);
                }
            });

            gardenDiv.appendChild(plantEl);
            updatePlantVisuals(plantEl, plant);
        });

        // Render grid cells for active step highlighting
        gridOverlay.innerHTML = '';
        for (let r = 0; r < GRID_ROWS; r++) {
            for (let c = 0; c < GRID_COLS; c++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.dataset.row = r;
                cell.dataset.col = c;
                gridOverlay.appendChild(cell);
            }
        }
    }

    function updatePlantVisuals(plantElement, plantData) {
        const { growth, health } = plantData;
        
        // Base scale influenced by growth
        const scaleFactor = 0.5 + (growth * 1.5); // From 0.5 to 2.0
        
        // Filter based on health and environmental factors
        let brightness = lerp(0.5, 1.2, health); // Health affects brightness
        brightness = lerp(brightness, 1.5, environment.sunlight); // Sunlight boosts brightness
        
        let saturation = lerp(0.5, 1.2, health); // Health affects saturation
        saturation = lerp(saturation, 1.5, environment.moisture); // Moisture boosts saturation
        
        let opacity = lerp(0.3, 1, health); // Health affects opacity
        
        // Season specific tint/filter
        switch (currentSeason) {
            case 'autumn': saturation *= 0.8; brightness *= 0.9; break; // Slightly desaturate, dim
            case 'winter': saturation *= 0.5; brightness *= 0.7; break; // More desaturated, colder
            case 'summer': saturation *= 1.2; brightness *= 1.1; break; // More vibrant
            // Spring is default vibrant
        }

        // Weather specific effects
        if (currentWeather === 'foggy') {
            opacity *= 0.7;
            brightness *= 0.9;
            saturation *= 0.8;
        }
        if (currentWeather === 'rainy') {
            saturation *= 0.9;
            brightness *= 0.9;
        }
        if (currentWeather === 'windy') {
            // Apply a slight transform for "windy" effect
            const windStrength = 0.05; // Max 5% tilt
            const tilt = Math.sin(Date.now() / 500) * windStrength; // Oscillate
            plantElement.style.transform = `scaleY(${scaleFactor}) rotate(${tilt * 10}deg)`;
        } else {
            plantElement.style.transform = `scaleY(${scaleFactor})`;
        }
        
        plantElement.style.filter = `brightness(${brightness}) saturate(${saturation})`;
        plantElement.style.opacity = opacity;
    }

    function updateAllPlantVisualsAndSounds() {
        plants.forEach(plant => {
            const plantEl = document.querySelector(`.plant[data-plant-id="${plant.id}"]`);
            if (plantEl) {
                updatePlantVisuals(plantEl, plant);
            }
            updatePlantSoundParameters(plant);
        });
    }

    // Attach click listener for garden planting
    gardenDiv.addEventListener('click', async (e) => {
        if (activeTool === 'plant' && !e.target.closest('.plant')) {
            const rect = gardenDiv.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const col = Math.floor(x / (rect.width / GRID_COLS));
            const row = Math.floor(y / (rect.height / GRID_ROWS));

            if (plants.some(p => p.row === row && p.col === col)) {
                alert('A plant already exists in this spot!');
                return;
            }

            // Before opening the modal, ensure audio is ready for eventual instrument creation
            await initAudio(); 

            // Open seed selection modal
            openModal(plantSeedModal);
            // Store target coordinates for when seed is selected
            plantSeedModal.dataset.targetRow = row;
            plantSeedModal.dataset.targetCol = col;
        }
    });

    // Toolbar button click handlers
    plantSeedBtn.addEventListener('click', () => {
        activeTool = 'plant';
        highlightActiveTool();
    });

    pruneBtn.addEventListener('click', () => {
        activeTool = 'prune';
        highlightActiveTool();
    });

    waterBtn.addEventListener('click', () => {
        activeTool = 'water';
        highlightActiveTool();
    });

    // New "Wild Growth" button handler
    wildGrowthBtn.addEventListener('click', async () => {
        await plantResonantField();
        activeTool = 'plant'; // Revert to plant tool after auto-planting
        highlightActiveTool();
    });
    
    function highlightActiveTool() {
        document.querySelectorAll('.toolbar button').forEach(btn => btn.classList.remove('active'));
        if (activeTool === 'plant') plantSeedBtn.classList.add('active');
        if (activeTool === 'prune') pruneBtn.classList.add('active');
        if (activeTool === 'water') waterBtn.classList.add('active');
        // No highlight for wild-growth, it's a one-shot action
    }

    // Main function to plant a single seed and create its audio instrument
    async function plantSeed(seedType, row, col) {
        if (!seedType || row === undefined || col === undefined) {
            console.error("Invalid seed type or coordinates for planting.");
            return;
        }

        // Ensure audio context and master effects are ready
        await initAudio(); 
        if (!audioInitialized || !masterDelay || !masterReverb || !masterEQ) {
            console.error("Tone.js master effects not initialized. Cannot plant seed.");
            alert("Audio system not ready. Please try clicking 'Play' first or refresh the page.");
            return;
        }

        const newPlant = {
            id: uuidv4(),
            type: seedType.id,
            row: row,
            col: col,
            growth: 0.1, // Initial growth
            health: 0.8, // Initial health
            instrument: null, // Placeholder for Tone.js instrument
            individualReverb: null, // Separate reverb for each plant
            individualDelay: null // Separate delay for each plant
        };

        let instrument;
        try {
            switch (seedType.instrumentType) {
                case 'Synth': instrument = new Tone.Synth(seedType.synthOptions); break;
                case 'PluckSynth': instrument = new Tone.PluckSynth(seedType.synthOptions); break;
                case 'MembraneSynth': instrument = new Tone.MembraneSynth(seedType.synthOptions); break;
                case 'PolySynth':
                    // FIX: Correct PolySynth initialization.
                    // PolySynth now takes an options object where 'voice' and 'polyphony' are properties.
                    const polySynthOptions = {
                        polyphony: seedType.synthOptions.polyphony,
                        voice: seedType.synthOptions.voice,
                        ...seedType.synthOptions.options // Spread any other options like oscillator/envelope
                    };
                    instrument = new Tone.PolySynth(polySynthOptions);
                    //console.log(`PolySynth created with options:`, polySynthOptions); // Debugging
                    break;
                default:
                    console.warn(`Unknown instrument type: ${seedType.instrumentType}. Defaulting to Tone.Synth.`);
                    instrument = new Tone.Synth();
            }
            newPlant.instrument = instrument;

            // Initialize individual effects for the plant and connect them
            newPlant.individualReverb = new Tone.Reverb().connect(masterReverb); // Connect to master reverb
            newPlant.individualDelay = new Tone.FeedbackDelay().connect(newPlant.individualReverb); // Connect to individual reverb
            newPlant.instrument.connect(newPlant.individualDelay); // Plant instrument connects to its own delay

            plants.push(newPlant);
            renderGarden(); // Re-render the garden to show the new plant
            updatePlantSoundParameters(newPlant); // Apply initial sound parameters
            closeModal(plantSeedModal);
            console.log(`Successfully planted ${seedType.name} at (${row}, ${col}). Total plants: ${plants.length}`);
        } catch (error) {
            console.error("Error creating or connecting instrument:", error);
            alert(`Failed to plant seed: ${error.message}. Check console for details.`);
            // Clean up any partially created Tone.js objects
            if (instrument) instrument.dispose();
            if (newPlant.individualReverb) newPlant.individualReverb.dispose();
            if (newPlant.individualDelay) newPlant.individualDelay.dispose();
        }
    }

    // Confirm seed selection from modal
    confirmSeedBtn.addEventListener('click', async () => {
        if (selectedSeedType && plantSeedModal.dataset.targetRow && plantSeedModal.dataset.targetCol) {
            await plantSeed(selectedSeedType,
                parseInt(plantSeedModal.dataset.targetRow),
                parseInt(plantSeedModal.dataset.targetCol)
            );
        } else {
            alert('Please select a seed first!');
        }
    });

    // Function to clear the entire garden
    function clearGarden() {
        stopBtn.click(); // Stop playback first
        plants.forEach(p => {
            p.instrument?.dispose();
            p.individualReverb?.dispose();
            p.individualDelay?.dispose();
        });
        plants = []; // Empty the plants array
        renderGarden(); // Re-render to show empty garden
        console.log("Garden cleared.");
    }

    // Function to prune a single plant
    function prunePlant(plantId) {
        const index = plants.findIndex(p => p.id === plantId);
        if (index > -1) {
            // Dispose of all associated Tone.js nodes
            if (plants[index].instrument) plants[index].instrument.dispose();
            if (plants[index].individualReverb) plants[index].individualReverb.dispose();
            if (plants[index].individualDelay) plants[index].individualDelay.dispose();
            
            plants.splice(index, 1); // Remove plant from array
            renderGarden(); // Re-render garden
            console.log(`Plant ${plantId} pruned. Remaining plants: ${plants.length}`);
        }
    }

    // Function to plant a resonant field
    async function plantResonantField() {
        clearGarden(); // Clear any existing plants first
        await initAudio(); // Ensure audio context is ready
        
        // --- FIX: Ensure Tone.Transport is running for scheduled events ---
        if (!isPlaying) {
            Tone.Transport.start();
            sequencer.start(0);
            isPlaying = true; // Update global state
            playBtn.innerHTML = `<svg class="btn-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M14.016 5.625h3.984v12.75h-3.984v-12.75zM6 5.625h4.031v12.75h-4.031v-12.75z"/></svg>Pause`;
            console.log("Tone.Transport started by Wild Growth.");
        }
        // --- END FIX ---

        console.log("Planting resonant field...");

        const cMajorScale = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5', 'D5']; // Extend scale for more range
        const numSeedTypes = seedTypes.length;
        let seedTypeIndex = 0;

        // A small buffer time before starting the actual planting sequence
        const startTime = Tone.Transport.currentTime + 0.1; // 100ms buffer

        // Iterate through columns to plant clusters
        for (let col = 0; col < GRID_COLS; col += 2) { // Plant in every other column
            const numPlantsInColumn = Math.floor(Math.random() * 3) + 2; // 2 to 4 plants per column
            const plantedRowsInColumn = new Set();

            for (let i = 0; i < numPlantsInColumn; i++) {
                let row;
                do {
                    row = Math.floor(Math.random() * GRID_ROWS); // Pick a random row
                } while (plantedRowsInColumn.has(row)); // Ensure unique row in this column

                plantedRowsInColumn.add(row);
                
                const currentSeedType = seedTypes[seedTypeIndex % numSeedTypes];
                seedTypeIndex++;

                // Schedule planting with a slight delay for visual effect
                // Use Tone.Transport.schedule for precise timing with audio
                const scheduleTime = startTime + (col * 0.05) + (i * 0.02); // Stagger planting slightly
                Tone.Transport.scheduleOnce(() => {
                    // Call plantSeed with a simple error check for demo purposes.
                    // In a real app, you might want more robust error handling here.
                    plantSeed(currentSeedType, row, col)
                        .catch(e => console.error(`Error planting in resonant field at (${row}, ${col}):`, e));
                }, scheduleTime);
            }
        }
        console.log("Resonant field planting scheduled. Plants will appear and play as transport runs.");
    }

    // Optional: a function to randomly prune a plant (not directly tied to Wild Growth)
    function autopruneRandomPlant() {
        if (plants.length > 0) {
            const randomIndex = Math.floor(Math.random() * plants.length);
            const plantToPrune = plants[randomIndex];
            prunePlant(plantToPrune.id);
            console.log("Random plant pruned.");
        } else {
            console.log("No plants to prune.");
        }
    }


    async function waterPlant(plantId) {
        await initAudio(); // Ensure audio context is ready for the water sound
        const plant = plants.find(p => p.id === plantId);
        if (plant) {
            plant.health = clamp(plant.health + 0.2, 0, 1); // Increase health
            plant.growth = clamp(plant.growth + 0.1, 0.1, 1); // Boost growth slightly
            const plantEl = document.querySelector(`.plant[data-plant-id="${plant.id}"]`);
            if (plantEl) {
                updatePlantVisuals(plantEl, plant);
                // Visual feedback for watering
                plantEl.style.transition = 'transform 0.1s ease-out, filter 0.1s ease-out';
                // To apply a temporary scale, get the current transform and then append/modify scale
                const currentTransformValue = plantEl.style.transform;
                plantEl.style.transform = `${currentTransformValue} scale(1.05)`; 
                
                setTimeout(() => {
                    // Reset transform after pulse. Careful with multiple transforms.
                    // A more robust solution might parse the existing transform string.
                    // For now, assume simple scaleY and rotate, and remove the temporary scale.
                    plantEl.style.transform = currentTransformValue.replace(' scale(1.05)', '');
                    plantEl.style.transition = 'transform 0.3s ease-out, filter 0.5s ease-out, opacity 0.3s ease-out';
                }, 100);
            }
            // Play a water sound effect
            if (!instruments.waterEffect) {
                instruments.waterEffect = new Tone.NoiseSynth({
                    noise: { type: 'pink' },
                    envelope: { attack: 0.01, decay: 0.3, sustain: 0.0, release: 0.1 }
                }).toDestination();
            }
            instruments.waterEffect.triggerAttackRelease(0.5);
            updatePlantSoundParameters(plant);
            console.log(`Plant ${plant.id} watered. Health: ${plant.health.toFixed(2)}, Growth: ${plant.growth.toFixed(2)}`);
        }
    }

    // --- Tone.js & Sequencing Core Initialization ---
    async function initAudio() {
        if (audioInitialized) return; // Only initialize once
        
        try {
            // Start audio context with explicit user gesture
            await Tone.start();
            
            // Check if context started properly
            if (Tone.context.state !== 'running') {
                console.warn('AudioContext not running. Attempting to resume...');
                await Tone.context.resume();
            }
            
            // Also explicitly handle the deprecation warning in console if desired, though Tone.js itself handles it.
            if (Tone.context.state === 'running') {
                console.warn("[Deprecation] The ScriptProcessorNode is deprecated. Tone.js might be using it internally. (https://bit.ly/audio-worklet)");
            }
            
            console.log('Tone.js AudioContext successfully started.');

            // Master Effects - only create these once
            masterReverb = new Tone.Reverb({ decay: 5, wet: 0.2 }).toDestination();
            masterDelay = new Tone.FeedbackDelay({ delayTime: "8n", feedback: 0.3, wet: 0.1 }).connect(masterReverb);
            masterEQ = new Tone.Filter(2000, "lowpass").connect(masterDelay); 

            // Sequencer setup
            sequencer = new Tone.Loop(sequenceStep, "16n"); // Call sequenceStep every 16th note
            Tone.Transport.bpm.value = tempo;
            Tone.Transport.loop = true;
            Tone.Transport.loopEnd = `${GRID_COLS}n`; // Loop every 16 steps (measures)

            // Background growth/health update loop
            Tone.Transport.scheduleRepeat(() => {
                plants.forEach(plant => {
                    // Gradual growth and health decay
                    plant.growth = clamp(plant.growth + (environment.growthRate * 0.001) + (environment.moisture * 0.0005) + (environment.sunlight * 0.0005), 0.1, 1);
                    plant.health = clamp(plant.health - 0.0001, 0, 1); 
                });
                updateAllPlantVisualsAndSounds(); // Update visuals and sound for all plants
            }, "1n"); // Run every quarter note (could be '1m' for every measure)

            audioInitialized = true; // Set flag to true
            updateMasterFX(); // Apply initial master effects based on current environment
            console.log('All Tone.js components initialized.');
        } catch (e) {
            console.error("Failed to initialize audio:", e);
            alert("Could not start audio. Please ensure your browser allows autoplay or try clicking the 'Play' button first.");
        }
    }

    // Update individual plant's sound parameters based on its state and environment
    function updatePlantSoundParameters(plant) {
        if (!audioInitialized || !plant.instrument || !plant.individualReverb || !plant.individualDelay) {
            //console.warn("Audio not initialized or plant instrument/effects missing. Skipping sound parameter update.");
            return; 
        }

        const { growth, health } = plant;
        const { moisture, sunlight } = environment; // GrowthRate isn't typically applied per plant sound

        let baseVolume = -10; // Default plant volume
        let filterFreq = lerp(500, 10000, growth); // More growth = brighter sound
        let filterQ = lerp(1, 10, health); // Health affects filter resonance/Q
        let reverbWet = lerp(0.05, 0.4, moisture); // Moisture affects reverb wetness
        let delayWet = lerp(0.05, 0.3, sunlight); // Sunlight affects delay wetness

        // Season specific sound tweaks
        switch (currentSeason) {
            case 'spring':
                filterFreq = Math.min(filterFreq * 1.1, 20000); // Brighter
                reverbWet = Math.min(reverbWet * 0.8, 0.5); // Slightly less reverb
                break;
            case 'summer':
                baseVolume += 2; // Louder
                delayWet = Math.min(delayWet * 1.5, 0.5); // More delay
                break;
            case 'autumn':
                filterFreq = Math.max(filterFreq * 0.8, 100); // Warmer, mellower
                reverbWet = Math.min(reverbWet * 1.2, 0.7); // More reverb
                break;
            case 'winter':
                filterFreq = Math.max(filterFreq * 0.6, 50); // Darker, muffled
                baseVolume -= 3; // Quieter
                reverbWet = Math.min(reverbWet * 1.5, 0.8); // More reverb
                break;
        }

        // Weather specific sound tweaks (can stack with season)
        switch (currentWeather) {
            case 'rainy':
                reverbWet = Math.min(reverbWet * 2, 0.9); // Much more reverb
                filterFreq = Math.max(filterFreq * 0.8, 100); // Slightly muffled
                break;
            case 'foggy':
                filterFreq = Math.max(filterFreq * 0.6, 50); // Heavily muffled
                baseVolume -= 2; // Quieter
                break;
            case 'windy':
                // Could add subtle vibrato or pitch shift for wind
                break;
        }

        // Apply parameters to instrument and its individual effects
        if (plant.instrument.volume) {
            plant.instrument.volume.value = baseVolume;
        }
        // Check if the instrument directly supports filter properties or if it's a PolySynth needing set()
        if (plant.instrument.filter) {
            plant.instrument.filter.frequency.value = filterFreq;
            plant.instrument.filter.Q.value = filterQ;
        } else if (plant.instrument.name === "PolySynth" && plant.instrument.set) { 
            // For PolySynth, apply voice options directly if they include filter properties
            plant.instrument.set({ voice: { filter: { frequency: filterFreq, Q: filterQ } } });
        }
        
        plant.individualReverb.wet.value = reverbWet;
        plant.individualDelay.wet.value = delayWet;
        plant.individualDelay.delayTime.value = "8n"; // Keep consistent or vary
    }

    // Update master effects based on overall environment/weather/season
    function updateMasterFX() {
        if (!audioInitialized || !masterReverb || !masterDelay || !masterEQ) {
            //console.warn("Master effects not initialized. Skipping master FX update.");
            return; 
        }

        let masterReverbDecay = 5;
        let masterReverbWet = 0.2;
        let masterEQFreq = 2000;
        let masterEQType = "lowpass";

        // Weather effects on master FX
        switch (currentWeather) {
            case 'rainy':
                masterReverbDecay = 8;
                masterReverbWet = 0.6;
                masterEQFreq = 800;
                break;
            case 'foggy':
                masterReverbDecay = 6;
                masterReverbWet = 0.4;
                masterEQFreq = 600;
                break;
            case 'windy':
                masterReverbDecay = 4;
                masterReverbWet = 0.2;
                masterEQFreq = 3000; // Brighter, more airy
                break;
            case 'sunny':
            default:
                // Defaults
                break;
        }

        // Season effects on master FX (can layer with weather)
        switch (currentSeason) {
            case 'spring':
                masterEQFreq = Math.min(masterEQFreq, 3000); // Cap brightness
                masterEQType = "highpass"; // Brighter overall
                break;
            case 'summer':
                masterEQFreq = Math.min(masterEQFreq, 2500); // Slightly less bright
                masterEQType = "lowpass"; 
                break;
            case 'autumn':
                masterEQFreq = Math.min(masterEQFreq, 1500); // Warmer
                masterEQType = "lowpass";
                break;
            case 'winter':
                masterEQFreq = Math.min(masterEQFreq, 1000); // Muffled
                masterEQType = "lowpass";
                break;
        }

        masterReverb.set({ decay: masterReverbDecay, wet: masterReverbWet });
        masterEQ.set({ frequency: masterEQFreq, type: masterEQType });
        // masterDelay parameters can also be modulated here if desired
    }

    // The main sequencing loop, triggered by Tone.Loop
    function sequenceStep(time) {
        if (!audioInitialized || !sequencer) {
            console.warn("Sequencer not initialized. Skipping step.");
            return; // Don't sequence if audio not ready
        }

        // Clear previous active step highlight
        const activeCells = gridOverlay.querySelectorAll('.grid-cell.active-step');
        activeCells.forEach(cell => cell.classList.remove('active-step'));

        // Highlight current step in the grid
        const currentColumnCells = document.querySelectorAll(`.grid-cell[data-col="${currentStep}"]`);
        currentColumnCells.forEach(cell => cell.classList.add('active-step'));

        plants.forEach(plant => {
            // Trigger plant's sound if it's in the current sequencer column
            if (plant.col === currentStep) {
                // Apply a minor visual 'pulse'
                const plantEl = document.querySelector(`.plant[data-plant-id="${plant.id}"]`);
                if (plantEl) {
                    plantEl.style.transition = 'transform 0.05s ease-out'; // Faster pulse
                    // Preserve existing transforms and add a temporary scale
                    const currentTransform = plantEl.style.transform || '';
                    plantEl.style.transform = `${currentTransform} scale(1.1)`; 
                    
                    Tone.Draw.schedule(() => {
                        // Remove the pulse scale after a short duration
                        plantEl.style.transform = currentTransform.replace(' scale(1.1)', '');
                        plantEl.style.transition = 'transform 0.3s ease-out, filter 0.5s ease-out, opacity 0.3s ease-out';
                    }, Tone.context.currentTime + 0.1); // Reset after a short delay
                }

                // Play sound based on plant type and growth
                let note;
                let duration = '8n';

                // Basic note mapping (can be more complex)
                const baseNotes = ['C3', 'D3', 'E3', 'F3', 'G3', 'A3', 'B3', 'C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5', 'D5']; // More notes
                note = baseNotes[plant.row % baseNotes.length];

                // Add randomness for generative feel, influenced by plant growth
                const randomPitchShift = (Math.random() - 0.5) * 2; // -1 to 1
                note = Tone.Frequency(note).transpose(randomPitchShift * 2 * plant.growth).toNote(); // Growth affects pitch variation range

                updatePlantSoundParameters(plant); // Apply latest parameters before playing

                if (plant.instrument && plant.instrument.triggerAttackRelease) {
                    plant.instrument.triggerAttackRelease(note, duration, time);
                }
            }
        });

        currentStep = (currentStep + 1) % GRID_COLS; // Advance to the next step
    }

    // Transport controls
    playBtn.addEventListener('click', async () => {
        try {
            // Always try to initialize audio on play, if not already
            await initAudio();

            if (audioInitialized) { // Proceed only if audio context is running
                if (!isPlaying) {
                    Tone.Transport.start();
                    sequencer.start(0); // Start the loop from the beginning
                    isPlaying = true;
                    playBtn.innerHTML = `
                        <svg class="btn-icon" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M14,19H18V5H14M6,19H10V5H6V19Z" />
                        </svg>
                        Pause
                    `;
                    console.log('Playback started.');
                } else {
                    Tone.Transport.pause();
                    sequencer.pause(); // Pause the loop
                    isPlaying = false;
                    playBtn.innerHTML = `
                        <svg class="btn-icon" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M8,5.14V19.14L19,12.14L8,5.14Z" />
                        </svg>
                        Play
                    `;
                    console.log('Playback paused.');
                }
            }
        } catch (error) {
            console.error('Error starting audio:', error);
        }
    });

    stopBtn.addEventListener('click', () => {
        if (!audioInitialized) return; // Only stop if Tone.js was initialized
        Tone.Transport.stop();
        sequencer.stop();
        isPlaying = false;
        currentStep = 0; // Reset sequencer step
        playBtn.innerHTML = `<svg class="btn-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M8,5.14V19.14L19,12.14L8,5.14Z"/></svg>Play`;
        // Clear active step highlight
        gridOverlay.querySelectorAll('.grid-cell.active-step').forEach(cell => cell.classList.remove('active-step'));
        console.log('Playback stopped.');
    });

    tempoSelect.addEventListener('change', (e) => {
        tempo = parseInt(e.target.value);
        if (Tone.Transport) { // Check if Tone.Transport is initialized
            Tone.Transport.bpm.value = tempo;
            console.log(`Tempo set to ${tempo} BPM.`);
        }
    });

    // --- Botanical Albums ---
    saveAlbumBtn.addEventListener('click', () => {
        const albumName = prompt('Enter a name for your botanical album:', `Garden ${new Date().toLocaleDateString()}`);
        if (albumName) {
            // Only save serializable data (no Tone.js objects)
            const albumData = {
                id: uuidv4(),
                name: albumName,
                timestamp: new Date().toISOString(),
                plants: plants.map(p => ({
                    id: p.id,
                    type: p.type,
                    row: p.row,
                    col: p.col,
                    growth: p.growth,
                    health: p.health
                })), 
                environment: { ...environment },
                season: currentSeason,
                weather: currentWeather,
                tempo: tempo
            };
            botanicalAlbums.push(albumData);
            saveAlbumsToLocalStorage();
            alert(`Album "${albumName}" saved!`);
            console.log(`Album "${albumName}" saved. Total albums: ${botanicalAlbums.length}`);
        }
    });

    function saveAlbumsToLocalStorage() {
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(botanicalAlbums));
    }

    function loadAlbumsFromLocalStorage() {
        try {
            const storedAlbums = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedAlbums) {
                botanicalAlbums = JSON.parse(storedAlbums);
                console.log(`Loaded ${botanicalAlbums.length} albums from local storage.`);
            } else {
                botanicalAlbums = [];
                console.log('No albums found in local storage.');
            }
        }
        catch (e) {
            console.error("Error loading albums from local storage:", e);
            botanicalAlbums = []; // Reset if corrupted
        }
    }

    viewAlbumsBtn.addEventListener('click', () => {
        renderAlbumList();
        openModal(viewAlbumsModal);
    });

    function renderAlbumList() {
        albumListContainer.innerHTML = ''; // Clear existing list
        if (botanicalAlbums.length === 0) {
            albumListContainer.appendChild(noAlbumsMessage);
            noAlbumsMessage.style.display = 'block';
            return;
        }
        noAlbumsMessage.style.display = 'none';

        botanicalAlbums.forEach(album => {
            const albumEntry = document.createElement('div');
            albumEntry.className = 'album-entry';

            const date = new Date(album.timestamp).toLocaleDateString();
            const time = new Date(album.timestamp).toLocaleTimeString();

            albumEntry.innerHTML = `
                <div class="album-details">
                    <h3>${album.name}</h3>
                    <p>Saved on: ${date} ${time}</p>
                    <p>Plants: ${album.plants.length}, Season: ${album.season}, Weather: ${album.weather}</p>
                </div>
                <div class="album-actions">
                    <button data-album-id="${album.id}" class="load-album-btn" style="background-color: var(--accent-color);">Load</button>
                    <button data-album-id="${album.id}" class="delete-album-btn" style="background-color: #d9534f;">Delete</button>
                </div>
            `;
            albumListContainer.appendChild(albumEntry);
        });

        // Add event listeners to dynamically created buttons
        albumListContainer.querySelectorAll('.load-album-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const albumId = e.target.dataset.albumId;
                const albumToLoad = botanicalAlbums.find(a => a.id === albumId);
                if (albumToLoad && confirm(`Load album "${albumToLoad.name}"? Current garden will be lost.`)) {
                    await loadAlbum(albumToLoad); // Ensure audio is ready
                    closeModal(viewAlbumsModal);
                    console.log(`Album "${albumToLoad.name}" loaded.`);
                }
            });
        });

        albumListContainer.querySelectorAll('.delete-album-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const albumId = e.target.dataset.albumId;
                if (confirm('Are you sure you want to delete this album? This cannot be undone.')) {
                    botanicalAlbums = botanicalAlbums.filter(a => a.id !== albumId);
                    saveAlbumsToLocalStorage();
                    renderAlbumList(); // Re-render list
                    console.log(`Album ${albumId} deleted.`);
                }
            });
        });
    }

    // Function to load a saved album state
    async function loadAlbum(albumData) {
        await initAudio(); // Ensure audio context is ready before creating new instruments

        // 1. Stop current playback
        stopBtn.click();

        // 2. Dispose of existing instruments to prevent memory leaks/zombie sounds
        plants.forEach(p => {
          p.instrument?.dispose(); // Use optional chaining
          p.individualReverb?.dispose();
          p.individualDelay?.dispose();
        });
        plants = []; // Clear current plants array

        // 3. Load new plants and create their instruments
        albumData.plants.forEach(plantData => {
            const seedType = seedTypes.find(s => s.id === plantData.type);
            if (seedType) {
                const newPlant = { ...plantData, instrument: null, individualReverb: null, individualDelay: null };
                let instrument;
                try {
                    switch (seedType.instrumentType) {
                        case 'Synth': instrument = new Tone.Synth(seedType.synthOptions); break;
                        case 'PluckSynth': instrument = new Tone.PluckSynth(seedType.synthOptions); break;
                        case 'MembraneSynth': instrument = new Tone.MembraneSynth(seedType.synthOptions); break;
                        case 'PolySynth':
                            // FIX: Correct PolySynth initialization for loading albums
                            const polySynthOptions = {
                                polyphony: seedType.synthOptions.polyphony,
                                voice: seedType.synthOptions.voice,
                                ...seedType.synthOptions.options
                            };
                            instrument = new Tone.PolySynth(polySynthOptions);
                            break;
                        default: instrument = new Tone.Synth();
                    }
                    newPlant.instrument = instrument;

                    newPlant.individualReverb = new Tone.Reverb().connect(masterReverb);
                    newPlant.individualDelay = new Tone.FeedbackDelay().connect(newPlant.individualReverb);
                    newPlant.instrument.connect(newPlant.individualDelay);
                    
                    plants.push(newPlant);
                } catch (e) {
                    console.error(`Error loading instrument for plant ${plantData.id}:`, e);
                    // Dispose partially created instruments to avoid issues
                    if (instrument) instrument.dispose();
                    if (newPlant.individualReverb) newPlant.individualReverb.dispose();
                    if (newPlant.individualDelay) newPlant.individualDelay.dispose();
                }
            } else {
                console.warn(`Seed type "${plantData.type}" not found for plant ${plantData.id}. Skipping.`);
            }
        });

        // 4. Load environment settings
        environment = { ...albumData.environment };
        setSeason(albumData.season);
        setWeather(albumData.weather);
        tempo = albumData.tempo;
        tempoSelect.value = tempo; // Update UI
        if (Tone.Transport) Tone.Transport.bpm.value = tempo; // Ensure Tone.js tempo is updated

        // 5. Update slider UIs visually based on loaded environment values
        updateSliderDisplay('growthRate');
        updateSliderDisplay('moisture');
        updateSliderDisplay('sunlight');
        
        // 6. Re-render garden and update sound parameters for all new/loaded plants
        renderGarden();
        updateAllPlantVisualsAndSounds();
        updateMasterFX(); // Ensure master effects are adjusted for the loaded state
        console.log(`Garden state loaded for album "${albumData.name}".`);
    }


    // --- Initialization on DOM Content Loaded ---
    function initializeBotanica() {
        // Pre-fill seed selection modal dynamically
        seedTypes.forEach(seed => {
            const seedCard = document.createElement('div');
            seedCard.className = 'seed-card';
            seedCard.dataset.seedId = seed.id;
            seedCard.innerHTML = `
                <div class="seed-icon">${seed.svg}</div>
                <div class="seed-name">${seed.name}</div>
            `;
            seedCard.addEventListener('click', () => {
                seedSelectionContainer.querySelectorAll('.seed-card').forEach(card => card.classList.remove('selected'));
                seedCard.classList.add('selected');
                selectedSeedType = seed;
                console.log(`Seed selected: ${seed.name}`);
            });
            seedSelectionContainer.appendChild(seedCard);
        });

        // Setup sliders once (attaches event listeners)
        setupSlider(growthRateHandle, 'growthRate');
        setupSlider(moistureHandle, 'moisture');
        setupSlider(sunlightHandle, 'sunlight');

        loadAlbumsFromLocalStorage(); // Attempt to load saved albums (this might update 'environment')
        renderGarden(); // Initial render of the garden (might be empty or loaded from album)
        setSeason(seasonSelect.value); // Set initial season visual/sound
        setWeather('sunny'); // Set initial weather visual/sound
        highlightActiveTool(); // Highlight the initial active tool

        // Initial update of slider displays based on environment defaults (or loaded album)
        // This is crucial to show the correct values after loading albums or defaults.
        updateSliderDisplay('growthRate');
        updateSliderDisplay('moisture');
        updateSliderDisplay('sunlight');

        console.log('Botanica initialized. Waiting for user interaction to start audio.');
    }

    // Call initialization function when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize the UI and visuals, but wait for user interaction for audio
      initializeBotanica();
      
      // Add a first-interaction handler to initialize audio
      const firstInteractionHandler = async () => {
        await initAudio();
        // Remove the event listeners after first interaction
        document.removeEventListener('click', firstInteractionHandler);
        document.removeEventListener('touchstart', firstInteractionHandler);
      };
      
      // Add event listeners for first interaction
      document.addEventListener('click', firstInteractionHandler);
      document.addEventListener('touchstart', firstInteractionHandler);
    });

  </script>
</body>
</html>